self.PQ_BAMBOO||(self.PQ_BAMBOO={}),self.addEventListener("load",()=>{const t=typeof WorkerGlobalScope!="undefined"&&self instanceof WorkerGlobalScope;if(t)return;const n=Array.from(document.getElementsByClassName("pq-bamboo")),e=[];for(const t of n){const s=new PQ_BAMBOO.CodeBlock({node:t});e.push(s)}self.BAMBOO=e}),PQ_BAMBOO.Helpers={Feedback:class{constructor(e,t){this.value=e.value.toString(),this.type=e.type,this.lineNumber=t}printPretty(e){return e=e.replace(/_(.*?)_/g,"<em>$1</em>"),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e}capitalize(e){return e.slice(0,1).toUpperCase()+e.slice(1)}print(e={}){let o=this.printPretty(this.value),t="<span class='line-num'>"+this.lineNumber+"</span>";this.lineNumber||(t="");let n=e.header||this.capitalize(this.type);n+=" > ";let s="bamboo-feedback-"+this.type;return e.class&&(s+=" "+e.class),"<div class='bamboo-feedback'><div class='"+s+"'>"+t+n+o+"</div></div>"}is(e){return this.type==e}isLiteral(){return this.type=="bool"||this.type=="number"||this.type=="string"}isBag(){return this.type=="bag"}},repeatString(e,t){let n="";for(let s=0;s<t;s++)n+=e;return n},divideString(e,t){for(let n=0;n<t.length;n++)e=e.replaceAll(t[n],"");return e}},PQ_BAMBOO.TypeCoercer={toBool(e){this.numberToBool(e),this.stringToBool(e)},numberToBool(e){if(e.type!="number")return;e.set(parseInt(e.value)!=0,"bool")},stringToBool(e){if(typeof e.value!="string")return;e.set(e.value.length>0,"bool")},toNumber(e){this.boolToNumber(e),this.stringToNumber(e)},boolToNumber(e){if(e.type!="bool")return;let t=e.value;typeof t=="string"&&(t=t=="true"),e.set(t?1:0,"number")},stringToNumber(e){if(typeof e.value!="string")return;const t=parseFloat(e.value);isNaN(t)?e.set("Can't use string **"+e.value+"** as a number","error"):e.set(t,"number")},toString(e){this.boolToString(e),this.numberToString(e)},boolToString(e){if(e.type!="bool")return;e.set(e.value,"string")},numberToString(e){if(e.type!="number")return;e.set(e.value.toString(),"string")}},PQ_BAMBOO.Operators={Identity:{toResult(e,t,n){return n.set(e.toResult(),e.type)}},Add:{toResult(e,t,n){return e.isBool()&&PQ_BAMBOO.TypeCoercer.toNumber(e),t.isBool()&&PQ_BAMBOO.TypeCoercer.toNumber(t),e.isNumber()&&t.isNumber()?n.set(e.toResult()+t.toResult(),"number"):n.set(e.toString()+t.toString(),"string")}},Sub:{toResult(e,t,n){if(e.isBool()&&PQ_BAMBOO.TypeCoercer.toNumber(e),t.isBool()&&PQ_BAMBOO.TypeCoercer.toNumber(t),e.isNumber()&&t.isNumber())return n.set(e.toResult()-t.toResult(),"number");if(e.isString()&&t.isNumber()){const s=e.toResult(),o=t.toResult();return n.set(s.slice(0,s.length-o),"string")}if(e.isNumber()&&t.isString())return n.set(t.toResult().slice(e.toResult()),"string");if(e.isString()&&t.isString()){let s=e.toResult();const o=t.toResult();return s.includes(o)&&(s=s.replace(o,"")),n.set(s,"string")}}},Mult:{toResult(e,t,n){if(e.isBool()&&PQ_BAMBOO.TypeCoercer.toNumber(e),t.isBool()&&PQ_BAMBOO.TypeCoercer.toNumber(t),e.isNumber()&&t.isNumber())return n.set(e.toResult()*t.toResult(),"number");if(e.isString()&&t.isNumber()){const s=PQ_BAMBOO.Helpers.repeatString(e.toResult(),t.toResult());return n.set(s,"string")}if(e.isNumber()&&t.isString()){const s=PQ_BAMBOO.Helpers.repeatString(t.toResult(),e.toResult());return n.set(s,"string")}e.isString()&&t.isString()}},Div:{toResult(e,t,n){if(e.isBool()&&PQ_BAMBOO.TypeCoercer.toNumber(e),t.isBool()&&PQ_BAMBOO.TypeCoercer.toNumber(t),e.isNumber()&&t.isNumber())return t.toResult()==0?n.set("Can't divide by zero!","error"):n.set(parseFloat(e.toResult())/parseFloat(t.toResult()),"number");if(e.isNumber()&&t.isString()){const s=t.toResult().length;return n.set(e.toResult()/s,"number")}if(e.isString()&&t.isNumber()){const s=e.toResult().length;return n.set(t.toResult()/s,"number")}if(e.isString()&&t.isString()){const s=PQ_BAMBOO.Helpers.divideString(e.toResult(),t.toResult());return n.set(s,"string")}}},Mod:{toResult(e,t,n){if(e.isBool()&&PQ_BAMBOO.TypeCoercer.toNumber(e),t.isBool()&&PQ_BAMBOO.TypeCoercer.toNumber(t),e.isNumber()&&t.isNumber())return n.set(e.toResult()%t.toResult(),"number");if(e.isString()&&t.isNumber()){const s=Math.round(e.toResult().length%t.toResult());return n.set(e.toResult().slice(0,s),"string")}if(e.isNumber()&&t.isString()){const s=t.toResult().length;return n.set(e.toResult()%s,"number")}if(e.isString()&&t.isString()){const s=e.toResult().replaceAll(t.toResult(),"");return n.set(s,"string")}}},Exp:{toResult(e,t,n){if(e.isNumber()&&t.isNumber()){const s=Math.pow(e.toResult(),t.toResult());return n.set(s,"number")}}},Equals:{toResult(e,t,n){const s=PQ_BAMBOO.TypeCoercer;return e.isNumber()&&t.isString()&&s.toNumber(t),e.isString()&&t.isNumber()&&s.toString(t),e.isBool()&&s.toBool(t),t.isBool()&&s.toBool(e),n.set(e.toResult()==t.toResult(),"bool")}},LogicalAnd:{toResult(e,t,n){return PQ_BAMBOO.TypeCoercer.toBool(e),PQ_BAMBOO.TypeCoercer.toBool(t),n.set(e.toResult()&&t.toResult(),"bool")}},LogicalOr:{toResult(e,t,n){return PQ_BAMBOO.TypeCoercer.toBool(e),PQ_BAMBOO.TypeCoercer.toBool(t),n.set(e.toResult()||t.toResult(),"bool")}},LogicalNot:{toResult(e,t,n){return PQ_BAMBOO.TypeCoercer.toBool(e),PQ_BAMBOO.TypeCoercer.toBool(t),n.set(!e.toResult(),"bool")}},Above:{toResult(e,t,n){return PQ_BAMBOO.TypeCoercer.toNumber(e),PQ_BAMBOO.TypeCoercer.toNumber(t),n.set(e.toResult()>t.toResult(),"bool")}},Below:{toResult(e,t,n){return PQ_BAMBOO.TypeCoercer.toNumber(e),PQ_BAMBOO.TypeCoercer.toNumber(t),n.set(e.toResult()<t.toResult(),"bool")}},Round:{toResult(e,t){return PQ_BAMBOO.TypeCoercer.toNumber(e),t.set(Math.round(e.toResult()),"number")}},Floor:{toResult(e,t){return PQ_BAMBOO.TypeCoercer.toNumber(e),t.set(Math.floor(e.toResult()),"number")}},Ceiling:{toResult(e,t){return PQ_BAMBOO.TypeCoercer.toNumber(e),t.set(Math.ceil(e.toResult()),"number")}},Absolute:{toResult(e,t){return PQ_BAMBOO.TypeCoercer.toNumber(e),t.set(Math.abs(e.toResult()),"number")}},Number:{toResult(e,t){return PQ_BAMBOO.TypeCoercer.toNumber(e),t.set(e.toResult(),"number")}},String:{toResult(e,t){return PQ_BAMBOO.TypeCoercer.toString(e),t.set(e.toResult(),"string")}},UpperCase:{toResult(e,t){return PQ_BAMBOO.TypeCoercer.toString(e),t.set(e.toResult().toUpperCase(),"string")}},LowerCase:{toResult(e,t){return PQ_BAMBOO.TypeCoercer.toString(e),t.set(e.toResult().toLowerCase(),"string")}}},PQ_BAMBOO.Nodes={Value:class{constructor(e=0,t="nothing",n=null,s=null){this.set(e,t),n&&(this.delimOpen=new PQ_BAMBOO.Nodes.Delimiter(n,"quote")),s&&(this.delimClose=new PQ_BAMBOO.Nodes.Delimiter(n,"quote"))}clone(){return new PQ_BAMBOO.Nodes.Value(structuredClone(this.value),structuredClone(this.type))}setLabel(e){this.label=e}getLabel(){return this.label}print(e){return new PQ_BAMBOO.Helpers.Feedback(this,e)}toResult(){const t=PQ_BAMBOO.TypeCoercer,e=this.clone();return this.type=="number"?t.toNumber(e):this.type=="bool"?t.toBool(e):this.type=="string"&&t.toString(e),e.value}toString(){return"<span class='value "+this.type+"'>"+(this.delimOpen?this.delimOpen.toString():"")+this.value.toString()+(this.delimClose?this.delimClose.toString():"")+"</span>"}toLogString(){return this.value+""}toOriginalString(){return this.value}set(e,t){return this.setValue(e),this.setType(t),this}setType(e){this.type=e}getType(){return this.type}setValue(e){this.value=e}getValue(){return this.value}update(e){const n=PQ_BAMBOO.config.operators["+"],t=new PQ_BAMBOO.Nodes.Value;return n.toResult(this,e,t),this.set(t.value,t.type),this}isError(){return this.type=="error"}isBool(){return this.type=="bool"}isNumber(){return this.type=="number"}isString(){return this.type=="string"}isKeyword(e=""){const t=this.type=="keyword";return e?t&&this.value==e:t}getKeyword(){return!this.type=="keyword"?null:this.value}isTrue(){return!this.isError()&&this.toResult()}getSize(){return new PQ_BAMBOO.Nodes.Value(this.toResult().length,"number")}getLabels(){}getItems(){}},ValueNamed:class{constructor(e,t,n){this.name=e,this.keyword=t,this.value=n}toString(){return"<span class='literal-named'>"+this.name.toString()+this.keyword.toString()+this.value.toString()+"</span>"}toResult(){const e=this.value.toResult().clone();return e.setLabel(this.getLabel()),e}getLabel(){return this.name.toOriginalString()}},Bag:class{constructor(e){this.name=e,this.content={}}clone(){const e=new PQ_BAMBOO.Nodes.Bag(this.name);return e.setContent(this.content),e}print(e){return new PQ_BAMBOO.Nodes.Value(this.toLogString(),"bag").print(e)}toLogString(){const e=[];for(const[t,n]of Object.entries(this.content))e.push(t+" => "+n);return"["+e.join(", ")+"]"}toResult(){return this}isKeyword(){return!1}getKeyword(){return null}isTrue(){return this.getSize()>0}getLabel(){return""}isError(){return!1}isBool(){return!1}isNumber(){return!1}isString(){return!1}setContent(e){this.content=e}addValue(e){let t=Object.keys(this.content).length,n=e;e.getLabel()&&(t=e.getLabel()),this.content[t]=n}removeValueByKey(e){const t=new PQ_BAMBOO.Nodes.Value("Bag **"+this.name+"** doesn't have key **"+e+"**","error");if(this.isArray())return e=parseInt(e),isNaN(e)?t:this.content.splice(e,1);if(e=e+"",console.log(this.content),console.log(e),console.log(this.content[e]),!(e in this.content))return t;const n=this.content[e];return delete this.content[e],n}push(e,t=null){return this.isArray()?(this.content.push(e),e):t?(this.content[t]=e,e):(this.addValue(e),e)}pop(){if(this.isEmpty())return new PQ_BAMBOO.Nodes.Value;if(this.isArray())return this.content.pop();const e=Object.keys(this.content),t=e[e.length-1],n=this.content[t];return delete this.content[t],n}getValue(e){const t=new PQ_BAMBOO.Nodes.Value("Bag **"+this.name+"** doesn't have key **"+e+"**","error");return this.isArray()?(e=parseInt(e),isNaN(e)?t:this.content[e]):(e=e+"",Object.keys(this.content).includes(e)?this.content[e]:t)}isEmpty(){return this.getSize()<=0}getSize(){let e=Object.keys(this.content).length;return this.isArray()&&(e=this.content.length),new PQ_BAMBOO.Nodes.Value(e,"number")}getLabels(){const e=new PQ_BAMBOO.Nodes.Bag(this.name+"-labels");return e.setContent(this.getKeysRaw()),e}getItems(){const e=new PQ_BAMBOO.Nodes.Bag(this.name+"-items");return e.setContent(this.getValuesRaw()),e}isArray(){return Array.isArray(this.content)}isObject(){return typeof this.content=="object"}getKeysRaw(){const e=[];if(this.isArray())for(let t=0;t<this.content.length;t++)e.push(t);else for(const t of Object.keys(this.content))e.push(new PQ_BAMBOO.Nodes.Value(t,"string"));return e}getValuesRaw(){return this.isArray()?this.content:Object.values(this.content)}getFirst(){if(this.getSize()<=0)return new PQ_BAMBOO.Nodes.Value;const e=Object.keys(this.content),t=e[0],n=this.content[t].toResult().clone();return n}getLast(){if(this.getSize()<=0)return new PQ_BAMBOO.Nodes.Value;const e=Object.keys(this.content),t=e[e.length-1],n=this.content[t].toResult().clone();return n}},Memory:class{constructor(e){this.contexts=[],this.config=e}pushContext(e=void 0,t=void 0){const n=new PQ_BAMBOO.Nodes.MemoryContext(e,t);return this.contexts.push(n),n.getData()}popContext(){return this.contexts.pop()}getLastContext(){return this.contexts[this.contexts.length-1]}scopeBlockingEnabled(){return!this.config.disabled.includes("scopeBlock")}error(e){return new PQ_BAMBOO.Nodes.Value("Name **"+e+"** doesn't exist in memory!","error")}has(e){for(let t=this.contexts.length-1;t>=0;t--){const n=this.contexts[t];if(n.has(e))return!0;if(this.scopeBlockingEnabled()&&n.blocksScope())break}return!1}get(e){for(let t=this.contexts.length-1;t>=0;t--){const n=this.contexts[t];if(n.has(e))return n.get(e);if(this.scopeBlockingEnabled()&&n.blocksScope())break}return this.error(e)}set(e,t){for(let n=this.contexts.length-1;n>=0;n--){const s=this.contexts[n];if(s.has(e))return s.set(e,t);if(this.scopeBlockingEnabled()&&s.blocksScope())break}return this.getLastContext().set(e,t)}delete(e){for(let t=this.contexts.length-1;t>=0;t--){const n=this.contexts[t];if(n.has(e))return n.delete(e);if(n.blocksScope())break}return this.error(e)}},MemoryContext:class{constructor(e=null,t={}){this.block=e,this.data=t}has(e){return e in this.data}get(e){return this.data[e]}set(e,t){return this.data[e]=t,t}delete(e){delete this.data[e]}getData(){return this.data}blocksScope(){return!!this.block&&!!this.block.header&&this.block.header.isDefinition(PQ_BAMBOO.Nodes.FunctionStatement)}},Delimiter:class{constructor(e,t){this.value=e,this.type=t}toString(){return"<span class='delimiter delimiter-"+this.type+"'>"+this.toOriginalString()+"</span>"}toOriginalString(){return this.value}},EmptyLine:class{constructor(e,t){this.space=new PQ_BAMBOO.Nodes.Delimiter(e,"space"),this.lineNumber=t}toString(){return"<span class='single-line-container'><span class='single-line'><span class='line-number'>"+this.lineNumber+"</span><span class='blank-line'>"+this.space.toString()+"</span></span></span>"}getLineNumber(){return this.lineNumber}},OperatorSymbol:class{constructor(e,t="",n="identity",s=""){this.config=e,this.symbol=n,t&&(this.spaceBefore=new PQ_BAMBOO.Nodes.Delimiter(t,"space")),s&&(this.spaceAfter=new PQ_BAMBOO.Nodes.Delimiter(s,"space"))}toString(){return this.symbol=="identity"?"":"<span class='operator'>"+(this.spaceBefore?this.spaceBefore.toString():"")+"<span class='operator-symbol'>"+this.symbol+"</span>"+(this.spaceAfter?this.spaceAfter.toString():"")+"</span>"}toOriginalString(){return this.symbol}getConfig(){return this.config}},Operator:class{constructor(e){this.operatorSymbol=e}toString(){return this.operatorSymbol.toString()}getSymbolString(){return this.operatorSymbol.toOriginalString()}toResult(e,t){const h=this.getSymbolString(),m=!t||h=="identity",a=new PQ_BAMBOO.Nodes.Value;let n=e.toResult().clone(),s=m?new PQ_BAMBOO.Nodes.Value:t.toResult().clone();const y=this.operatorSymbol.getConfig();if(y.disabled.includes("typeCoercion")&&!m&&n.getType()!=s.getType())return a.set("Invalid comparison between data types","error"),a;const c=[];if(n.isError()&&c.push(n),s.isError()&&c.push(s),c.length>0)return a.set(c,"error"),a;const l=[];if(n.isKeyword()&&l.push(n),s.isKeyword()&&l.push(s),l.length>0)return a.set(l,"keyword"),a;let o=[n],i=[s],j=n instanceof PQ_BAMBOO.Nodes.Bag,g=s instanceof PQ_BAMBOO.Nodes.Bag,d=[];j&&(o=n.getValuesRaw(),d=n.getKeysRaw()),g&&(i=s.getValuesRaw(),d=s.getKeysRaw());const r=[],u=o.length==1||i.length==1,v=o.length==i.length&&!u,b=o.length!=i.length&&!u;if(u||b)for(let e=0;e<o.length;e++)for(let t=0;t<i.length;t++){let n=new PQ_BAMBOO.Nodes.Value;PQ_BAMBOO.config.operators[h].toResult(o[e],i[t],n),r.push(n)}if(v){const e=Math.max(o.length,i.length);for(let t=0;t<e;t++){let n=new PQ_BAMBOO.Nodes.Value;PQ_BAMBOO.config.operators[h].toResult(o[t],i[t],n),r.push(n)}}if(r.length==1)return r[0];const p={};for(let e=0;e<d.length;e++)p[d[e]]=r[e];const f=new PQ_BAMBOO.Nodes.Bag("unnamed");return f.setContent(p),f}},Literal:class{constructor(e,t="",n=""){this.value=e,t!=""&&(this.delimOpen=new PQ_BAMBOO.Nodes.Delimiter(t,"open")),n!=""&&(this.delimClose=new PQ_BAMBOO.Nodes.Delimiter(t,"close"))}toString(){let e="<span class='literal literal-"+this.value.getType()+"'>";return this.delimOpen&&(e+=this.delimOpen.toString()),e+=this.value.toString(),this.delimClose&&(e+=this.delimClose.toString()),e+="</span>",e}toResult(){return this.value}},BambooKeyword:class{constructor(e,t,n){this.lexer=e,this.keyword1=t,this.keyword2=n}toString(){return"<span class='bamboo-keyword'>"+this.keyword1.toString()+this.keyword2.toString()+"</span>"}toResult(){const e=this.keyword2.toString();if(e=="random")return new PQ_BAMBOO.Nodes.Value(Math.random(),"number");if(e=="time"){const e=new PQ_BAMBOO.Nodes.Bag("time"),t=new Date,n={year:"getFullYear",month:"getMonth",day:"getDate",hours:"getHours",minutes:"getMinutes",seconds:"getSeconds",milliseconds:"getMilliseconds"};for(const[o,i]of Object.entries(n)){const s=new PQ_BAMBOO.Nodes.Value(t[i](),"number");s.setLabel(o),e.addValue(s)}return e}const t=this.getBambooMemory(e);return t||new PQ_BAMBOO.Nodes.Value("There's no **Bamboo** global with the name **"+e+"**","error")}getBambooMemory(e){return this.lexer.getBambooMemory(e)}},FactorKeyword:class{constructor(e,t){this.keyword=e,this.value=t}toString(){return"<span class='factor-keyword'>"+this.keyword.toString()+this.value.toString()+"</span>"}toResult(){const s=PQ_BAMBOO.config.operators[this.keyword.toOriginalString()];let t=[this.value.toResult()];const o=t[0]instanceof PQ_BAMBOO.Nodes.Bag;o&&(t=this.value.toResult().getValuesRaw());const e=[];for(const o of t){const n=new PQ_BAMBOO.Nodes.Value;s.toResult(o.clone(),n),e.push(n)}if(e.length==1)return e[0];const n=new PQ_BAMBOO.Nodes.Bag("unnamed");return n.setContent(e),n}},Factor:class{constructor(e="",t,n=""){this.value=t,e&&(this.delimOpen=new PQ_BAMBOO.Nodes.Delimiter(e,"open")),n&&(this.delimClose=new PQ_BAMBOO.Nodes.Delimiter(n,"close"))}toString(){return"<span class='factor'>"+(this.delimOpen?this.delimOpen.toString():"")+this.value.toString()+(this.delimClose?this.delimClose.toString():"")+"</span>"}toResult(){return this.value.toResult()}},Term:class{constructor(e,t,n){this.factor=e,t||(t=new PQ_BAMBOO.Nodes.OperatorSymbol),this.operator=new PQ_BAMBOO.Nodes.Operator(t),n&&(this.term=n)}toString(){return"<span class='term'>"+this.factor.toString()+(this.operator&&this.term?this.operator.toString()+this.term.toString():"")+"</span>"}toResult(){return this.operator.toResult(this.factor,this.term)}},Comment:class{constructor(e,t){this.delim=new PQ_BAMBOO.Nodes.Delimiter(e,"comment"),this.value=new PQ_BAMBOO.Nodes.Value(t,"comment")}toString(){return"<span class='comment'>"+this.delim.toString()+"<span class='comment-content'>"+this.value+"</span></span>"}toResult(){return this.value}},Expression:class{constructor(e,t,n){this.term=e,t||(t=new PQ_BAMBOO.Nodes.OperatorSymbol),this.operator=new PQ_BAMBOO.Nodes.Operator(t),n&&(this.expression=n)}toString(){return"<span class='expression'>"+this.term.toString()+(this.operator&&this.expression?this.operator.toString()+this.expression.toString():"")+"</span>"}toResult(){return this.operator.toResult(this.term,this.expression)}},Conditional:class{constructor(e,t,n,s){this.keyword1=e,this.value1=t,this.operator=new PQ_BAMBOO.Nodes.Operator(n),this.value2=s}toString(){return"<span class='conditional'>"+(this.keyword1?this.keyword1.toString():"")+(this.value1?this.value1.toString():"")+this.operator.toString()+this.value2.toString()+"</span>"}toResult(){return this.value1?this.operator.toResult(this.value1,this.value2):this.operator.toResult(this.value2)}},Assignment:class{constructor(e,t,n,s){this.keyword1=e,this.value1=t,this.keyword2=n,this.value2=s}toString(){return"<span class='assignment'>"+this.keyword1.toString()+this.value1.toString()+(this.keyword2?this.keyword2.toString():"")+(this.value2?this.value2.toString():"")+"</span>"}toResult(){let e,t,n;if(this.keyword1.is("put"))e=this.value1.toResult(),t=this.value2.toOriginalString(),this.value2.getMemory().set(t,e),n=e;else if(this.keyword1.is("now"))t=this.value1.toOriginalString(),e=this.value2.toResult(),this.value1.getMemory().set(t,e),n=e;else if(this.keyword1.is("change")){t=this.value1.toOriginalString(),e=this.value2.toResult();let s=this.value1.getMemory().get(t);s.type!="error"&&s.update(e),n=s}else if(this.keyword1.is("delete")){t=this.value1.toOriginalString();let e=this.value1.getMemory();n=e.delete(t)}return n}},LogStatement:class{constructor(e,t){this.keyword=e,this.value=t}toString(){return"<span class='log-statement'>"+this.keyword.toString()+this.value.toString()+"</span>"}toResult(){const t=this.value.toResult(),e=new PQ_BAMBOO.Nodes.Value(t.toLogString(),"log");return console.log(e),e}},IfStatement:class{constructor(e,t){this.keyword=e,this.conditional=t}toString(){return"<span class='if-statement'>"+this.keyword.toString()+this.conditional.toString()+"</span>"}toResult(){return this.conditional.toResult()}isTrue(){return this.toResult().isTrue()}},BagStatement:class{constructor(e,t,n){this.keyword1=e,this.name=t,this.keyword2=n}toString(){return"<span class='bag-statement'>"+this.keyword1.toString()+this.name.toString()+this.keyword2.toString()+"</span>"}toResult(){return new PQ_BAMBOO.Nodes.Value("Creation of a new bag: "+this.toOriginalString(),"parser")}getBagName(){return this.name.toOriginalString()}},BagPush:class{constructor(e,t,n,s,o){this.lexer=e,this.keyword1=t,this.value=n,this.keyword2=s,this.bagName=o}toString(){return"<span class='bag-push'>"+this.keyword1.toString()+this.value.toString()+this.keyword2.toString()+this.bagName.toString()+"</span>"}toResult(){const e=this.lexer.getMemory().get(this.bagName.toOriginalString()),t=this.value.toResult();return e.push(t)}},BagPop:class{constructor(e,t,n,s,o,i){this.lexer=e,this.keyword1=t,this.key=n,this.keyword2=s,this.keyword3=o,this.bagName=i}toString(){return"<span class='bag-push'>"+this.keyword1.toString()+(this.key?this.key.toString():"")+this.keyword2.toString()+this.keyword3.toString()+this.bagName.toString()+"</span>"}toResult(){const e=this.lexer.getMemory().get(this.bagName.toOriginalString());if(this.key){const n=this.key instanceof PQ_BAMBOO.Nodes.Variable;let t="";return n?t=this.key.toKey():t=this.key.toResult().toOriginalString(),e.removeValueByKey(t)}return e.pop()}},StringSlice:class{constructor(e,t,n,s,o,i){this.keyword1=e,this.value1=t,this.keyword2=n,this.value2=s,this.keyword3=o,this.value3=i}toString(){return"<span class='slice-statement'>"+this.keyword1.toString()+this.value1.toString()+this.keyword2.toString()+this.value2.toString()+this.keyword3.toString()+this.value3.toString()+"</span>"}toResult(){const e=this.value3.toResult().clone(),t=this.value1.toResult(),n=this.value2.toResult().clone();PQ_BAMBOO.TypeCoercer.toString(e),PQ_BAMBOO.TypeCoercer.toNumber(t),PQ_BAMBOO.TypeCoercer.toNumber(n);const s=e.toResult().slice(t.toResult(),n.toResult());return new PQ_BAMBOO.Nodes.Value(s,"string")}},StringReplace:class{constructor(e,t,n,s,o,i){this.keyword1=e,this.value1=t,this.keyword2=n,this.value2=s,this.keyword3=o,this.value3=i}toString(){return"<span class='replace-statement'>"+this.keyword1.toString()+this.value1.toString()+this.keyword2.toString()+this.value2.toString()+this.keyword3.toString()+this.value3.toString()+"</span>"}toResult(){const e=this.value3.toResult().clone(),t=this.value1.toResult().clone(),n=this.value2.toResult().clone();PQ_BAMBOO.TypeCoercer.toString(e),PQ_BAMBOO.TypeCoercer.toString(t),PQ_BAMBOO.TypeCoercer.toString(n);const s=e.toResult().replaceAll(t.toResult(),n.toResult());return new PQ_BAMBOO.Nodes.Value(s,"string")}},LoopStatement:class{constructor(e,t,n){this.keyword1=e,t&&(this.value=t),n&&(this.keyword2=n)}toString(){return"<span class='loop-statement'>"+this.keyword1.toString()+(this.value?this.value.toString():"")+(this.keyword2?this.keyword2.toString():"")+"</span>"}toResult(){return new PQ_BAMBOO.Nodes.Value(this.keyword1,"keyword")}getLoopCount(){return this.value?this.value.toResult().toResult():PQ_BAMBOO.config.maxLoopCount}},SearchStatement:class{constructor(e,t){this.keyword=e,this.bag=t}toString(){return"<span class='search-statement'>"+this.keyword.toString()+this.bag.toString()+"</span>"}isInvalid(){return!(this.bag.toResult()instanceof PQ_BAMBOO.Nodes.Bag)}toResult(){return new PQ_BAMBOO.Nodes.Value(this.keyword,"keyword")}getLoopCount(){if(this.isInvalid())return 0;const e=this.bag.toResult().getSize();return e.toResult()}getLoopValues(){return this.isInvalid()?[]:this.bag.toResult().getValuesRaw()}},ParamList:class{constructor(e,t){if(!e){this.list=[];return}this.list=[e],t&&(this.list=this.list.concat(t.flat()))}toString(){let e="<span class='function-parameters'>";for(const t of this.list)e+=t.toString();return e+="</span>",e}toResult(){}getParamsAsList(e=!0){const t=[];for(const n of this.list){if(n instanceof PQ_BAMBOO.Nodes.Keyword)continue;e?t.push(n.toOriginalString()):t.push(n.toResult())}return t}},FunctionStatement:class{constructor(e,t,n,s){this.keyword1=e,this.name=t,this.keyword2=n,this.params=s}toString(){return"<span class='function-statement'>"+this.keyword1.toString()+this.name.toString()+(this.keyword2?this.keyword2.toString():"")+(this.params?this.params.toString():"")+"</span>"}toResult(){return new PQ_BAMBOO.Nodes.Value(this.getFunctionName(),"function")}getFunctionName(){return this.name.toOriginalString()}getParamsAsList(){return this.params?this.params.getParamsAsList():[]}},Function:class{constructor(e,t,n){this.name=e,this.block=t,this.memory=n}call(e){const s=this.block.header.getDefinition(),t=s.getParamsAsList(!0),n=e.getParamsAsList(!1),o=Math.min(t.length,n.length);for(let e=0;e<o;e++){const s=t[e],i=n[e];this.memory[s]=i}return this.block.toResult(!0)}},BagName:class{constructor(e){this.value=e}toString(){return"<span class='bag-name'>"+this.toOriginalString()+"</span>"}toOriginalString(){return this.value}toResult(){}},FunctionName:class{constructor(e){this.value=e}toString(){return"<span class='function-name'>"+this.toOriginalString()+"</span>"}toOriginalString(){return this.value.toString()}toResult(){}},FunctionCall:class{constructor(e,t,n,s,o){this.lexer=e,this.keyword1=t,this.keyword2=s,t&&s?(this.name=o,this.paramsList=n):s||(this.name=n,this.paramsList=null)}toString(){return"<span class='function-call'>"+this.keyword1.toString()+(this.paramsList?this.paramsList.toString():"")+(this.keyword2?this.keyword2.toString():"")+this.name.toString()+"</span>"}toResult(){const t=this.name.toOriginalString(),e=this.getMemory().get(t);return e instanceof PQ_BAMBOO.Nodes.Function?e.call(this.getParamsList()):e}getParamsList(){return this.paramsList?this.paramsList:new PQ_BAMBOO.Nodes.ParamList}getMemory(){return this.lexer.memory}},FunctionParameter:class{constructor(e){this.value=e}toString(){return"<span class='function-parameter'>"+this.value.toString()+"</span>"}toResult(){}toOriginalString(){return this.value.toString()}},Keyword:class{constructor(e,t,n){this.space1=new PQ_BAMBOO.Nodes.Delimiter(e,"space"),this.value=t,this.space2=new PQ_BAMBOO.Nodes.Delimiter(n,"space")}toString(){return"<span class='keyword'>"+this.space1.toString()+this.value.toString()+this.space2.toString()+"</span>"}toResult(){return new PQ_BAMBOO.Nodes.Value(this.value,"keyword")}toOriginalString(){return this.value}is(e){return this.value==e}},Variable:class{constructor(e,t){this.lexer=e,this.value=t}toString(){return"<span class='variable'>"+this.value.toString()+"</span>"}toResult(){return this.getMemory().get(this.value)}existsInMemory(){return this.getMemory().has(this.value)}isReservedKeyword(){return["size","labels","items"].includes(this.toOriginalString())}toKey(){return this.isReservedKeyword()?this.toOriginalString():this.existsInMemory()?this.toResult().toResult():this.toOriginalString()}getLabel(e){const t=this.toResult(),o=t instanceof PQ_BAMBOO.Nodes.Bag,n=e,s=e instanceof PQ_BAMBOO.Nodes.Value;if(s&&(e=e.toOriginalString()),e=="size")return t.getSize();if(e=="labels")return t.getLabels();if(e=="items")return t.getItems();if(o)return t.getValue(e);const i=t.getType()=="string";if(i){const o=e;s&&n.getType()=="number"&&(o=n.toResult());const i=isNaN(o),a=!i;if(i){const e=t.toResult().indexOf(o);return new PQ_BAMBOO.Nodes.Value(e,"number")}if(a){const e=t.toResult().at(o);return new PQ_BAMBOO.Nodes.Value(e,"string")}}const a=Array.isArray(e)||typeof e=="object";return a?t[e]:new PQ_BAMBOO.Nodes.Value("Can't access **"+e+"** on **"+this.toOriginalString()+"**","error")}toOriginalString(){return this.value}getMemory(){return this.lexer.memory}},VariableIndexed:class{constructor(e,t,n){this.variable=e,this.delimiter=t,this.label=n}toString(){return"<span class='variable-indexed'>"+this.variable.toString()+this.delimiter.toString()+this.label.toString()+"</span>"}toResult(){const e=this.label.toKey();return this.variable.getLabel(e)}},Label:class{constructor(e){this.value=e}toString(){return"<span class='label'>"+this.value.toString()+"</span>"}toKey(){console.log("VALUE BEFORE"),console.log(this.value);let e=this.value;const t=e instanceof PQ_BAMBOO.Nodes.Variable;if(t){let t=e.toKey();if(t)return t}const n=e instanceof PQ_BAMBOO.Nodes.Value;return n||(e=e.toResult()),console.log("VALUEUUE"),console.log(e),e.toResult()}},Statement:class{constructor(e){this.spaceBefore=0,this.spaceAfter=0,this.value=e}toString(){let e=new Array(this.spaceBefore),t=new Array(this.spaceAfter);return e=e.fill(" ").join(""),t=t.fill(" ").join(""),this.spaceBefore==0&&(e=""),this.spaceAfter==0&&(t=""),"<span class='single-line-container'><span class='single-line'><span class='line-number'>"+this.lineNumber+"</span><span class='statement'>"+e+this.value.toString()+t+"</span></span></span>"}toResult(){return this.value.toResult()}setSpaceBefore(e){this.spaceBefore=e}setSpaceAfter(e){this.spaceAfter=e}getSpaceBefore(){return this.spaceBefore}getDefinition(){return this.value}isDefinition(e){return this.value instanceof e}setLineNumber(e){this.lineNumber=e}getLineNumber(){return this.lineNumber}},Block:class{constructor(e){this.lexer=e,this.content=[],this.header=null,this.parent=null,this.feedback=[],this.memory={}}getLexer(){return this.lexer}addBlock(e){this.content.push(e)}addStatement(e){this.content.push(e)}getParentBlock(){return this.parent}setParentBlock(e){e.addBlock(this),this.parent=e}setHeader(e){this.header=e}toString(){let e=[];this.header&&e.push(this.header.toString());for(const t of this.content)e.push(t.toString());return"<span class='block'>"+e.join(`
`)+"</span>"}toResult(e=!1){this.feedback=[],this.parentMemory=this.lexer.memory.getLastContext();const t=this.toHeaderResult(e);if(t.result.type!="nothing"){const e=this.header.getLineNumber();this.feedback.push(t.result.print(e))}if(!t.execute)return this.bubbleUpFeedback(),t.result;t.newContext&&this.lexer.memory.pushContext(this,this.memory);const s=[];for(const e of this.content){const t=e instanceof PQ_BAMBOO.Nodes.EmptyLine;if(t)continue;s.push(e)}let n=0,o=t.loopValues,i=new PQ_BAMBOO.Nodes.Value,a=t.bag||new PQ_BAMBOO.Nodes.Bag;for(;!0;){let e=!t.loop;const c=new PQ_BAMBOO.Nodes.Value(n,"number");this.lexer.setBambooMemory("iterator",c);let r=new PQ_BAMBOO.Nodes.Value("No loop value (possibly not looping over a bag?)","error");n<o.length&&(r=o[n]),this.lexer.setBambooMemory("value",r);for(const o of s){const n=o.toResult(),c=o instanceof PQ_BAMBOO.Nodes.Block;if(!c){const e=o.getLineNumber();this.feedback.push(n.print(e))}const l=n.getKeyword(),r=t.keywords.includes(l);if(r&&(n.isKeyword("output")||n.isKeyword("unplug"))){e=!0;break}if(i=n,a.addValue(n),r&&n.isKeyword("skip"))break;if(r&&n.isKeyword("stop")){e=!0;break}}if(n+=1,e=e||n>=t.loopCount||n>=PQ_BAMBOO.config.maxLoopCount,e)break}return this.bubbleUpFeedback(),this.toHeaderCleanup(t),i}bubbleUpFeedback(){const e=!this.parent;if(e)return;this.parent.addFeedback(this.feedback)}addFeedback(e){this.feedback=this.feedback.concat(e)}getFeedback(){return this.feedback}toHeaderCleanup(e){e.newContext&&this.lexer.memory.popContext()}toHeaderResult(e=!1){const t={execute:!0,loop:!1,loopCount:1,loopValues:[],newContext:!1,bag:null,keywords:[],result:new PQ_BAMBOO.Nodes.Value};if(!this.header)return t;const s=this.header.isDefinition(PQ_BAMBOO.Nodes.IfStatement),o=this.header.isDefinition(PQ_BAMBOO.Nodes.LoopStatement),i=this.header.isDefinition(PQ_BAMBOO.Nodes.SearchStatement),a=this.header.isDefinition(PQ_BAMBOO.Nodes.BagStatement),n=this.header.isDefinition(PQ_BAMBOO.Nodes.FunctionStatement);if(n&&(t.keywords=["unplug","output"]),t.newContext=!0,e)return t;if(s)return t.execute=this.header.getDefinition().isTrue(),t.execute||t.result.set("If statement false; skipped","parser"),t;if(o)return t.loopCount=this.header.getDefinition().getLoopCount(),t.loop=t.loopCount>0,t.keywords=["stop","skip"],t.result.set("Loop statement ("+t.loopCount+" times)","parser"),t;if(i)return t.loopCount=this.header.getDefinition().getLoopCount(),t.loop=t.loopCount>0,t.loopValues=this.header.getDefinition().getLoopValues(),t.keywords=["stop","skip"],t.result.set("Loop statement (through bag)","parser"),t;if(a){const e=this.header.getDefinition().getBagName(),n=new PQ_BAMBOO.Nodes.Bag(e,this.memory);return this.parentMemory.set(e,n),t.result.set("Bag defined","parser"),t.bag=n,t}if(n){const e=this.header.getDefinition().getFunctionName(),n=new PQ_BAMBOO.Nodes.Function(e,this,this.memory);return this.parentMemory.set(e,n),t.execute=!1,t.result.set("Machine defined with name "+e,"parser"),t}return t}containsKeyword(e,t="stop"){return e.toResult()==t}},Code:class{constructor(e){this.blocks=e}toString(){let e="<span class='code'>";for(const t of this.blocks)e+=t.toString();return e+="</span>",e}toResult(){let e=[];for(const t of this.blocks)e=e.concat(t.toResult());return e}}};const o=PQ_BAMBOO.Operators;PQ_BAMBOO.config={maxLoopCount:20,workerURL:"/tutorials/js/pqBamboo-parser.js",builtinGlobals:["iterator","value","random","time","draw","update"],tabCharacter:"\u00a0",tabSize:2,builtinFunctions:["number","round","ceiling","floor","abs","string","uppercase","lowercase"],keywords:["plus","minus","times","divide","put","into","change","by","delete","now","means","if","is","and","or","not","above","below","true","false","both","either","stop","repeat","skip","search","machine","wants","give","to","use","unplug","output","say","comment","replace","with","select","in","from","add","to","take","out","of"],operators:{identity:o.Identity,"+":o.Add,plus:o.Add,"-":o.Sub,minus:o.Sub,"*":o.Mult,times:o.Mult,"/":o.Div,divide:o.Div,"%":o.Mod,mod:o.Mod,"^":o.Exp,exp:o.Exp,"=":o.Equals,is:o.Equals,"!":o.LogicalNot,not:o.LogicalNot,"&&":o.LogicalAnd,and:o.LogicalAnd,"||":o.LogicalOr,or:o.LogicalOr,above:o.Above,">":o.Above,below:o.Below,"<":o.Below,round:o.Round,floor:o.Floor,ceiling:o.Ceiling,abs:o.Absolute,number:o.Number,string:o.String,uppercase:o.UpperCase,lowercase:o.LowerCase}},PQ_BAMBOO.config.keywords=PQ_BAMBOO.config.keywords.concat(PQ_BAMBOO.config.builtinFunctions).concat(PQ_BAMBOO.config.builtinGlobals),PQ_BAMBOO.Parser=class{setLexer(e){this.lexer=e}returnerDefault=e=>e;choice=(e,t=this.returnerDefault)=>{let n=e.slice();return s=>{if(!e.length)return[];let o=e[0];const a=o.length==0;a&&(o=o());const i=o(s),r=i.length;return r?[t(i[0]),i[1]]:this.choice(n.slice(1),t)(s)}};reducerDefault=e=>e.join("");seq=(e,t=this.reducerDefault)=>{let n=e.slice();return e=>{const o=(e,t)=>{const i=!e.length;if(i)return t;let n=e[0];const a=n.length==0;a&&(n=n());const r=t[1],s=n(r),c=s.length;if(!c)return[];const l=t[0],d=[...l,s[0]],u=[d,s[1]];return o(e.slice(1),u)},s=o(n,[[],e]),i=s.length>0;return i?[t(s[0]),s[1]]:[]}};someReduceDefault=e=>e.join("");some=(e,t=this.someReduceDefault)=>n=>{const s=(t,n)=>{const o=[t,n];if(!n)return o;const i=e(n),a=i.length;if(!a){const e=!o[0];return e?[]:o}const r=[...t,i[0]],c=i[1];return s(r,c)},[o,i]=s("",n),a=o;return a?[t(o),i]:[]};maybe=(e,t=void 0,n=void 0)=>this.choice([this.some(e,n),this.nothing],t);char=e=>t=>t.length?t[0]!=e?[]:[t[0],t.slice(1)]:[];charSpace=e=>e.length?/\s/.test(e[0])?[e[0],e.slice(1)]:[]:[];range=(e,t)=>n=>n[0]>=e&&n[0]<=t?[n[0],n.slice(1)]:[];nothing=e=>["",e];all=e=>[e,""];fail=e=>[];zero=this.char("0");onenine=this.range("1","9");digit=this.choice([this.zero,this.onenine]);digits=this.some(this.digit);sign=this.choice([this.char("+"),this.char("-"),this.nothing]);integer=this.choice([this.digits,this.digit,this.seq([this.sign,this.digits])]);fraction=this.choice([this.seq([this.char("."),this.digits]),this.nothing]);varChar=(e=!1)=>{const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",n=t+"0123456789";return s=>e?this.charChoice(t)(s):this.charChoice(n)(s)};varChars=this.seq([this.varChar(!0),this.maybe(this.varChar(!1))]);charChoice=e=>t=>t.length?e.includes(t[0])?[t[0],t.slice(1)]:[]:[];charChoiceList=e=>t=>{const n=[];for(const t of e)n.push(this.charChoice(t));return this.choice(n)(t)};chars=e=>t=>{if(t.length<e.length)return[];const n=t.slice(0,e.length)==e;return n?[t.slice(0,e.length),t.slice(e.length)]:[]};charNot=e=>t=>t.length&&t[0]===e?[]:[t[0],t.slice(1)];charsNot=e=>t=>t.length&&e.includes(t[0])?[]:[t[0],t.slice(1)];stringChar=this.charsNot(['"',`
`,`
`,``]);stringChars=this.maybe(this.stringChar);boolReturner=e=>new PQ_BAMBOO.Nodes.Value(e=="true","bool");bool=this.choice([this.chars("true"),this.chars("false")],this.boolReturner);numberReduce=([e,t])=>new PQ_BAMBOO.Nodes.Value(e+t,"number");number=this.seq([this.integer,this.fraction],this.numberReduce);stringReduce=([e,t,n])=>new PQ_BAMBOO.Nodes.Value(t,"string",e,n);string=this.seq([this.char('"'),this.stringChars,this.char('"')],this.stringReduce);literalReturner=e=>new PQ_BAMBOO.Nodes.Literal(e);literal=this.choice([this.bool,this.number,this.string],this.literalReturner);optSpace=this.maybe(this.charSpace);reqSpace=e=>e.length<=0?this.nothing(e):this.some(this.charSpace)(e);charsExact=e=>t=>{if(t.length>e.length){const n=this.charSpace(t[e.length]).length;if(!n)return[]}return this.chars(e)(t)};operator=(e="+",t=!1)=>n=>{const s=([e,t,n])=>new PQ_BAMBOO.Nodes.OperatorSymbol(this.lexer.config,e,t,n);let o=this.seq([this.optSpace,this.chars(e),this.optSpace],s);return t&&(o=this.seq([this.optSpace,this.chars(e),this.reqSpace],s)),o(n)};keywordReducer=([e,t,n])=>new PQ_BAMBOO.Nodes.Keyword(e,t,n);keyword=e=>this.seq([this.optSpace,this.chars(e),this.reqSpace],this.keywordReducer);keywordChoiceList=PQ_BAMBOO.config.keywords.map(e=>this.charsExact(e));iskeyword=this.choice(this.keywordChoiceList);namedValue=e=>t=>{const n=this.iskeyword(t),s=n.length;return s?this.fail(t):this.seq([this.varChars],e)(t)};bagNameReducer=([e])=>new PQ_BAMBOO.Nodes.BagName(e);bagName=this.namedValue(this.bagNameReducer);functionNameReducer=([e])=>new PQ_BAMBOO.Nodes.FunctionName(e);functionName=this.namedValue(this.functionNameReducer);functionParamReducer=([e])=>new PQ_BAMBOO.Nodes.FunctionParameter(e);functionParameter=this.namedValue(this.functionParamReducer);variableReducer=([e])=>new PQ_BAMBOO.Nodes.Variable(this.lexer,e);variable=this.namedValue(this.variableReducer);possessiveReducer=([e,t,n])=>new PQ_BAMBOO.Nodes.Delimiter(e+t+n,"possessive");possessive=this.seq([this.optSpace,this.chars("'s"),this.optSpace],this.possessiveReducer);labelReducer=([e])=>new PQ_BAMBOO.Nodes.Label(e);label=this.seq([this.choice([this.literal,this.variable,()=>this.evaluation])],this.labelReducer);variableIndexedReducer=([e,t,n])=>new PQ_BAMBOO.Nodes.VariableIndexed(e,t,n);variableIndexed=this.seq([this.variable,this.possessive,this.label],this.variableIndexedReducer);paramList=(e=!1)=>t=>{let n=this.functionParameter;e&&(n=()=>this.evaluation);const s=e=>e.flat(),o=([e,t])=>[e,t],i=this.maybe(this.seq([this.keyword("and"),n],o),void 0,s),a=([e,t])=>new PQ_BAMBOO.Nodes.ParamList(e,t);return this.seq([n,i],a)(t)};functionCallReducer=([e,t,n,s])=>new PQ_BAMBOO.Nodes.FunctionCall(this.lexer,e,t,n,s);functionCallWithParams=this.seq([this.keyword("give"),this.paramList(!0),this.keyword("to"),this.functionName],this.functionCallReducer);functionCallWithoutParams=this.seq([this.keyword("use"),this.functionName],this.functionCallReducer);functionCall=this.choice([this.functionCallWithoutParams,this.functionCallWithParams]);factorBracket=this.seq([this.char("("),this.optSpace,()=>this.evaluation,this.optSpace,this.char(")")],([e,t,n,s,o])=>new PQ_BAMBOO.Nodes.Factor(e+t,n,s+o));literalNamedReducer=([e,t,n])=>new PQ_BAMBOO.Nodes.ValueNamed(e,t,n);literalNamed=this.seq([this.bagName,this.keyword("means"),()=>this.evaluation],this.literalNamedReducer);factor=this.choice([this.factorBracket,this.literalNamed,this.literal,this.functionCall,this.variableIndexed,this.variable]);termOperator=(e,t)=>this.seq([this.operator(e,t),()=>this.term],([e,t])=>({op:e,term:t}));termChoice=this.choice([this.termOperator("^",!1),this.termOperator("exp",!0),this.termOperator("*",!1),this.termOperator("times",!0),this.termOperator("/",!1),this.termOperator("divide",!0),this.termOperator("%",!1),this.termOperator("mod",!0),this.nothing]);termReducer=([e,t])=>t?new PQ_BAMBOO.Nodes.Term(e,t.op,t.term):e;term=this.seq([this.factor,this.termChoice],this.termReducer);exprOperator=(e,t)=>this.seq([this.operator(e,t),()=>this.expression],([e,t])=>({op:e,expr:t}));exprChoice=this.choice([this.exprOperator("+",!1),this.exprOperator("plus",!0),this.exprOperator("-",!1),this.exprOperator("minus",!0),this.nothing]);expressionReducer=([e,t])=>t?new PQ_BAMBOO.Nodes.Expression(e,t.op,t.expr):e;expression=this.seq([this.term,this.exprChoice],this.expressionReducer);condOneOperator=(e,t)=>{const n=([e,t,n])=>new PQ_BAMBOO.Nodes.Conditional(null,e,t,n);return this.seq([this.expression,this.operator(e,t),()=>this.conditional],n)};condTwoOperator=(e,t,n)=>{const s=([e,t,n,s])=>new PQ_BAMBOO.Nodes.Conditional(e,t,n,s);return this.seq([this.keyword(e,n),this.expression,this.operator(t,n),()=>this.conditional],s)};unaryReducer=([e,t])=>new PQ_BAMBOO.Nodes.Conditional(null,null,e,t);unaryNot=this.choice([this.seq([this.operator("!",!1),()=>this.conditional],this.unaryReducer),this.seq([this.operator("not",!0),()=>this.conditional],this.unaryReducer)]);condOneKeyword=this.choice([this.condOneOperator("=",!1),this.condOneOperator("is",!0),this.condOneOperator(">",!1),this.condOneOperator("above",!0),this.condOneOperator("<",!1),this.condOneOperator("below",!0)]);condTwoKeyword=this.choice([this.condTwoOperator("both","and",!0),this.condTwoOperator("either","or",!0)]);conditional=this.choice([this.unaryNot,this.condTwoKeyword,this.condOneKeyword,this.expression]);factorKeywordChoice=()=>{const e=[];for(const t of PQ_BAMBOO.config.builtinFunctions)e.push(this.keyword(t));return this.choice(e)};factorKeyword=this.seq([this.factorKeywordChoice(),()=>this.conditional],([e,t])=>new PQ_BAMBOO.Nodes.FactorKeyword(e,t));bambooGlobalChoice=()=>{const e=[];for(const t of PQ_BAMBOO.config.builtinGlobals)e.push(this.chars(t));return this.choice(e)};bambooKeyword=this.seq([this.keyword("bamboo"),this.bambooGlobalChoice()],([e,t])=>new PQ_BAMBOO.Nodes.BambooKeyword(this.lexer,e,t));replaceReducer=([e,t,n,s,o,i])=>new PQ_BAMBOO.Nodes.StringReplace(e,t,n,s,o,i);stringReplace=this.seq([this.keyword("replace"),()=>this.evaluation,this.keyword("with"),()=>this.evaluation,this.keyword("in"),()=>this.evaluation],this.replaceReducer);sliceReducer=([e,t,n,s,o,i])=>new PQ_BAMBOO.Nodes.StringSlice(e,t,n,s,o,i);stringSlice=this.seq([this.keyword("select"),()=>this.evaluation,this.keyword("to"),()=>this.evaluation,this.keyword("from"),()=>this.evaluation],this.sliceReducer);bagPushReducer=([e,t,n,s])=>new PQ_BAMBOO.Nodes.BagPush(this.lexer,e,t,n,s);bagPush=this.seq([this.keyword("add"),this.choice([()=>this.evaluation,this.literalNamed]),this.keyword("to"),this.bagName],this.bagPushReducer);bagPopReducer=([e,t,n,s,o])=>new PQ_BAMBOO.Nodes.BagPop(this.lexer,e,t,n,s,o);bagPop=this.seq([this.keyword("take"),this.choice([()=>this.evaluation,this.nothing]),this.keyword("out"),this.keyword("of"),this.bagName],this.bagPopReducer);evaluation=this.choice([this.bambooKeyword,this.factorKeyword,this.bagPush,this.bagPop,this.stringReplace,this.stringSlice,this.conditional]);loopReducer=([e,t,n])=>new PQ_BAMBOO.Nodes.LoopStatement(e,t,n);blockSomeReducer=e=>e[0];loopStatement=this.seq([this.keyword("repeat"),this.maybe(this.evaluation,void 0,this.blockSomeReducer),this.maybe(this.keyword("times"),void 0,this.blockSomeReducer)],this.loopReducer);searchReducer=([e,t])=>new PQ_BAMBOO.Nodes.SearchStatement(e,t);searchStatement=this.seq([this.keyword("search"),this.evaluation],this.searchReducer);functionStatementReducer=([e,t,n,s])=>new PQ_BAMBOO.Nodes.FunctionStatement(e,t,n,s);functionStatement=this.seq([this.keyword("machine"),this.functionName,this.maybe(this.keyword("wants"),void 0,this.blockSomeReducer),this.maybe(this.paramList(!1),void 0,this.blockSomeReducer)],this.functionStatementReducer);commentReducer=([e,t])=>new PQ_BAMBOO.Nodes.Comment(e,t);comment=this.seq([this.choice([this.char(">"),this.keyword("comment")]),this.stringChars],this.commentReducer);logReducer=([e,t])=>new PQ_BAMBOO.Nodes.LogStatement(e,t);logStatement=this.seq([this.keyword("say"),this.evaluation],this.logReducer);assignmentReducer=([e,t,n,s])=>new PQ_BAMBOO.Nodes.Assignment(e,t,n,s);assignmentNow=this.seq([this.keyword("now"),this.variable,this.keyword("means"),this.evaluation],this.assignmentReducer);assignmentPut=this.seq([this.keyword("put"),this.evaluation,this.keyword("into"),this.variable],this.assignmentReducer);assignmentChange=this.seq([this.keyword("change"),this.variable,this.keyword("by"),this.evaluation],this.assignmentReducer);assignmentDelete=this.seq([this.keyword("delete"),this.variable],this.assignmentReducer);assignment=this.choice([this.assignmentNow,this.assignmentPut,this.assignmentChange,this.assignmentDelete]);ifReducer=([e,t,n])=>new PQ_BAMBOO.Nodes.IfStatement(e,t,n);ifStatement=this.seq([this.keyword("if"),this.evaluation],this.ifReducer);bagReducer=([e,t,n])=>new PQ_BAMBOO.Nodes.BagStatement(e,t,n);bagStatement=this.seq([this.keyword("bag"),this.bagName,this.keyword("holds")],this.bagReducer);oneKeywordStatements=this.choice([this.keyword("stop"),this.keyword("skip"),this.keyword("unplug"),this.keyword("output")]);multiKeywordStatements=this.choice([this.logStatement,this.ifStatement,this.loopStatement,this.searchStatement,this.functionStatement,this.bagStatement,this.assignment,this.comment,this.evaluation]);statement=this.choice([this.oneKeywordStatements,this.multiKeywordStatements],e=>new PQ_BAMBOO.Nodes.Statement(e))},PQ_BAMBOO.PARSER=new PQ_BAMBOO.Parser,PQ_BAMBOO.Lexer=class{constructor(e){this.config=e,this.memory=new PQ_BAMBOO.Nodes.Memory(e),this.memoryGlobal=this.memory.pushContext(),this.memoryGlobal.bamboo={}}getBambooMemory(e){return this.memoryGlobal.bamboo[e]}setBambooMemory(e,t){this.memoryGlobal.bamboo[e]=t}getMemory(){return this.memory}isInvalid(e){return!(e instanceof PQ_BAMBOO.Nodes.Block)}isEmptyLine(e){const t=e.replace(/\s/g,"");return t.length<=0}parse(e){const t=this.parseCode(e);return this.isInvalid(t)?null:t}parseCode(e){const r=e.length-e.replaceAll("(","").length,c=e.length-e.replaceAll(")","").length;if(r!=c)return null;const l=e.split(/[\n]/),i=PQ_BAMBOO.PARSER;i.setLexer(this);const t=[];let a=!1,o=0;for(let e of l){if(o+=1,this.isEmptyLine(e)){t.push(new PQ_BAMBOO.Nodes.EmptyLine(e,o));continue}e=e.replace("	","\u00a0\u00a0");const r=e.search(/\S/);e=e.slice(r);const c=e.length-e.trim().length;e=e.trim();const s=i.statement(e),d=!s.length||s[1]!="";if(d){a=!0;break}const n=s[0];t.push(n),n.setSpaceBefore(r),n.setSpaceAfter(c),n.setLineNumber(o)}if(a)return null;const s=[0];let n=new PQ_BAMBOO.Nodes.Block(this);for(let e=0;e<t.length;e++){const i=s[s.length-1];let o=i;const a=e>=t.length-1;if(a)o=0;else{const n=t[e+1]instanceof PQ_BAMBOO.Nodes.EmptyLine;n||(o=t[e+1].getSpaceBefore())}const r=o>i;if(r){s.push(o);const i=new PQ_BAMBOO.Nodes.Block(this);i.setParentBlock(n),i.setHeader(t[e]),n=i;continue}n.addStatement(t[e]);const c=o<i;if(c){const e=s.indexOf(o);for(let t=s.length-1;t>e;t--)s.pop(),n=n.getParentBlock();continue}}return console.log(n),n}},PQ_BAMBOO.SyntaxHighlighter=class{constructor(e,t,n){this.bambooBlock=e,this.codeInput=t,this.codeDisplay=n,this.codeInput.addEventListener("keydown",this.handleCustomKeys.bind(this)),this.enabled=!0,this.selection,this.content,this.method="textarea",window.addEventListener("resize",this.updateDimensions.bind(this))}SelectionResult=class{constructor(e,t,n){this.anchorIndex=e,this.focusIndex=t,this.currentIndex=n}};updateDimensions(){if(this.method!="textarea")return;const e=this.codeDisplay.getBoundingClientRect().height+"px";this.codeDisplay.parentNode.style.height=e,this.codeInput.style.height=e}setEnabled(e){this.enabled=e}handleTab(e){const o=e.key=="Tab";if(!o)return;e.preventDefault(),e.stopPropagation();const t=this.codeInput,n=t.value;let i=n.slice(0,t.selectionStart),a=n.slice(t.selectionEnd,t.value.length),s=t.selectionEnd+1;t.value=i+"\u00a0"+a,t.selectionStart=s,t.selectionEnd=s,t.focus(),this.bambooBlock.onInput()}handleEnter(){return!1}handleCustomKeys(e){if(!e)return!0;if(e.handled)return!0;this.handleTab(e),this.handleEnter(e)}getTextareaWithoutStyling(){let t=this.codeInput.value,e=t.split(`
`);for(let t=0;t<e.length;t++)e[t]="<span class='single-line-container'><span class='single-line'><span class='line-number'>"+(t+1)+"</span><span class='statement'>"+e[t]+"</span></span></span>";return e.join(`
`)}prepareStyling(){if(this.method=="textarea")return this.codeDisplay.innerHTML=this.getTextareaWithoutStyling(),this.codeInput.value;if(this.method=="editable"){const{selection:t,content:e}=this.getSelectionAndContent();return this.selection=t,this.content=e,e}}finishStyling(e){if(!this.enabled)return;this.method=="textarea"&&this.renderParsedText(e),this.method=="editable"&&e&&(this.renderParsedTextContentEditable(e),this.restoreSelection(this.selection))}getSelectionAndContent(){const t=window.getSelection(),o=this.getTextSegments();let n=null,s=null,e=0;o.forEach(({text:o,node:i})=>{i===t.anchorNode&&(n=e+t.anchorOffset),i===t.focusNode&&(s=e+t.focusOffset),e+=o.length}),n==null&&(n=e),s==null&&(s=e);const i=new this.SelectionResult(n,s,e),a=o.map(({text:e})=>e).join("");return{selection:i,content:a}}restoreSelection(e){const t=e.anchorIndex,n=e.focusIndex,c=window.getSelection(),l=this.getTextSegments();let s=this.node,o=this.node,i=0,a=0,r=0;l.forEach(({text:e,node:c})=>{const l=r,d=l+e.length;l<=t&&t<=d&&(s=c,i=t-l),l<=n&&n<=d&&(o=c,a=n-l),r+=e.length,lastText=e,lastNode=c}),c.setBaseAndExtent(s,i,o,a),this.node.focus()}getTextSegments(e=this.node){const t=[],n=Array.from(e.childNodes);return n.forEach(e=>{switch(e.nodeType){case Node.TEXT_NODE:t.push({text:e.nodeValue,node:e});break;case Node.ELEMENT_NODE:t.splice(t.length,0,...this.getTextSegments(e));break;default:throw new Error(`Unexpected node type: ${e.nodeType}`)}}),t}renderParsedText(e){if(this.updateDimensions(),!e||e=="")return;this.codeDisplay.innerHTML=e}renderParsedTextContentEditable(e){if(!e||e=="")return;this.node.innerHTML=e,this.node.innerHTML+="<br/><br/>"}},PQ_BAMBOO.CodeBlock=class{constructor(e){this.node=e.node,this.setupHTML(),this.parseResult=this.node.getElementsByClassName("parse-result")[0],this.feedback=this.parseResult.getElementsByClassName("parse-result-content")[0],this.debug=this.node.getElementsByClassName("bamboo-debug")[0],this.configForm=this.node.getElementsByClassName("bamboo-config-container")[0];const t=this;console.log(this.node),this.foldNode=this.node.getElementsByClassName("bamboo-fold")[0],this.isFolded()?(this.codeContainer.style.display="none",this.parseResult.style.display="none",this.foldNode.addEventListener("click",this.unfold.bind(this))):this.foldNode.style.display="none",this.configButton=this.node.getElementsByClassName("bamboo-config-btn")[0],this.configButton.addEventListener("click",e=>{const n=t.configForm.style.display=="block";return n?t.configForm.style.display="none":t.configForm.style.display="block",e.preventDefault(),e.stopPropagation(),!1}),this.highlighter=new PQ_BAMBOO.SyntaxHighlighter(this,this.codeInput,this.codeDisplay),this.codeInput.addEventListener("input",this.onInput.bind(this));const n=!this.isFolded();n&&this.onInput()}isFolded(){return this.node.dataset.folded=="true"}unfold(){this.node.dataset.folded="false",this.codeContainer.style.display="block",this.parseResult.style.display="block",this.foldNode.style.display="none",this.onInput()}onInput(){this.startExecuting()}startExecuting(){const e=this.highlighter.prepareStyling();this.feedback.innerHTML="Executing ...",this.thread&&this.thread.terminate(),this.thread=new Worker(PQ_BAMBOO.config.workerURL),this.thread.addEventListener("message",this.finishExecuting.bind(this));let t={code:e,config:this.getConfig()};this.thread.postMessage(JSON.stringify(t))}finishExecuting(e){const t=JSON.parse(e.data),n=Object.keys(t).length<=0;if(n){this.highlighter.finishStyling("");return}this.highlighter.finishStyling(t.text),this.feedback.innerHTML=t.feedback,this.parseResult.style.display="block",t.feedback.length<=0&&(this.parseResult.style.display="none")}removeEmptyLinesAtStart(){const t=this.codeInput;let e=t.innerHTML;for(;!0;){const t=e.search(/\S/);if(t<=0)break;e=e.slice(1)}t.innerHTML=e}setupHTML(){this.codeContainer=this.node.getElementsByClassName("code-block")[0],this.codeInput=this.node.getElementsByClassName("code-block-input"),this.codeInput.length>0?this.codeInput=this.codeInput[0]:(this.codeInput=document.createElement("textarea"),this.codeInput.classList.add("code-block-input"),this.codeContainer.appendChild(this.codeInput)),this.codeDisplay=this.node.getElementsByClassName("code-block-display"),this.codeDisplay.length>0?this.codeDisplay=this.codeDisplay[0]:(this.codeDisplay=document.createElement("div"),this.codeDisplay.classList.add("code-block-display"),this.codeContainer.appendChild(this.codeDisplay)),this.codeDisplay.setAttribute("spellcheck",!1),this.codeInput.setAttribute("spellcheck",!1),this.setConfigInputs(),this.removeEmptyLinesAtStart()}setConfigInputs(){const e=this.node;let t=e.getElementsByClassName("bamboo-config-container")[0];const n=t.getElementsByTagName("input");for(const t of n)t.checked=e.dataset[t.name]=="true"}getConfig(){const n={disabled:[],fb:{log:!0,result:!0,value:!0,keyword:!0}},e={};Object.assign(e,n);const t=this.node,s=this.configForm.getElementsByTagName("input");for(const e of s)t.dataset[e.name]=e.checked;e.disabled=t.dataset.disabled.split(",");for(const n in e.fb)e.fb[n]=t.dataset["fb"+n]=="true";return e}},PQ_BAMBOO.Tests={runningAll:!1,profile:!1,time:!0,reportResults:!1,onlyParse:!1,runAll(){if(this.runningAll)return;const e=Object.keys(this.tests);this.runningAll=!0,this.run(...e),this.runningAll=!1},run(...e){const t=Date.now();for(const t of e){console.log("== Running Test ("+t+") =="),this.profile&&console.profile();const n=Date.now(),s=this.tests[t].bind(this);s();const o=Date.now();this.profile&&console.profileEnd(),this.time&&console.log("> Time: "+(o-n)+" ms"),console.log("== End ==")}const n=Date.now();this.time&&console.log("> Total Time: "+(n-t)+" ms")},true(e,t="",n=null,s=null){const o=e(t);return this.reportResults&&console.log(o),!!this.onlyParse||o.length>0&&(o[0]==n||n==null)&&(o[1]==s||s==null)},trueInstance(e,t="",n,s=null){const o=e(t);return this.reportResults&&console.log(o),!!this.onlyParse||o.length>0&&o[0]instanceof n&&(o[1]==s||s==null)},toResult(e,t,n){const s=e(t);if(!s)return null;if(this.onlyParse)return!0;const o=s[0].toResult();return this.reportResults&&console.log(o),o.toResult()==n},tests:{bools(){const e=console.assert,s=PQ_BAMBOO.PARSER,t=this.true.bind(this),n=s.bool;e(t(n,"true")),e(t(n,"false")),e(!t(n,"tru")),e(t(n,"true that",void 0," that"))},numbers(){const s=PQ_BAMBOO.PARSER,e=console.assert,t=this.true.bind(this),n=s.number;e(t(n,"321")),e(t(n,"3.2")),e(t(n,"0.321")),e(t(n,"0.0321")),e(t(n,"-3")),e(t(n,"+3")),e(t(n,"-3.2")),e(t(n,"+3.2")),e(!t(n,"text")),e(!t(n,"true")),e(t(n,"3 3",null," 3")),e(t(n,"2-2",null,"-2"))},strings(){const s=PQ_BAMBOO.PARSER,t=console.assert,n=this.true.bind(this);let e=s.char("c");t(n(e,"cat","c")),t(!n(e,"dog")),e=s.chars("cat"),t(n(e,"cataco","cat")),t(!n(e,"cadog")),t(!n(e,"ca")),e=s.charnot("c"),t(!n(e,"cat")),t(n(e,"dog","d")),t(!n(e,"cataco")),e=s.charchoice("cat"),t(n(e,"ahoy","a")),t(!n(e,"dog")),e=s.charchoicelist(["w","a","t"]),t(n(e,"willow","w")),e=s.charchoicelist(["cat","dog","well"]),t(n(e,"apple","a")),e=s.range("a","z"),t(n(e,"d")),e=s.range("3","9"),t(!n(e,"2")),e=s.varchar(!1),t(n(e,"h")),t(!n(e,"-")),e=s.varchars,t(n(e,"hello")),t(!n(e," hello")),t(!n(e,"he llo","hello")),e=s.stringchar,t(n(e,"h")),t(!n(e,'"')),e=s.stringchars,t(n(e,"hekl9063289j-=.")),t(!n(e,'hel"lo','hel"lo')),e=s.charsexact("true"),t(n(e,"true")),t(!n(e,"truela")),e=s.charsexact("use"),t(!n(e,"users"))},variables(){const o=PQ_BAMBOO.PARSER,n=console.assert;let t=this.trueInstance.bind(this);const s=PQ_BAMBOO.Nodes;let e=o.variable;n(t(e,"khelkh",s.Variable)),n(!t(e,"true",s.Variable)),n(t(e,"kle a",s.Variable," a")),e=o.literal,n(t(e,"true",s.Literal)),n(t(e,"false",s.Literal)),n(t(e,'"hehek"',s.Literal)),n(t(e,"3.6309",s.Literal)),t=this.true.bind(this),e=o.iskeyword,n(t(e,"true"))},arithmetic_plus_min(){const s=PQ_BAMBOO.PARSER,e=s.statement,t=this.toResult.bind(this),n=console.assert;n(t(e,"5+5","10")),n(t(e,"5 + 10","15")),n(t(e,"-5 + 10","5")),n(t(e,"5-5","0")),n(t(e,"5-10","-5")),n(t(e,"5+-10","-5"))},arithmetic_mult_div(){const s=PQ_BAMBOO.PARSER,e=s.statement,t=this.toResult.bind(this),n=console.assert;n(t(e,"5*5","25")),n(t(e,"5 * 10","50")),n(t(e,"-5 * 10","-50")),n(t(e,"5/5","1")),n(t(e,"5/10","0.5")),n(t(e,"5/5/5","5")),n(t(e,"5 mod 2","1")),n(t(e,"2.5 mod 1.5","1")),n(t(e,"-5 mod -3","-2"))},artihmetic_exp(){const s=PQ_BAMBOO.PARSER,e=s.statement,t=this.toResult.bind(this),n=console.assert;n(t(e,"2^2","4")),n(t(e,"0.5^3","0.125")),n(t(e,"5^2+3","28"))},arithmetic_factor(){const s=PQ_BAMBOO.PARSER,e=s.statement,t=this.toResult.bind(this),n=console.assert;n(t(e,"(2+3)^2","25")),n(t(e,"(2+3)/(2+3)","1")),n(t(e,"(2-1/2)^(2-1)","1.5"))},conditionals(){const i=PQ_BAMBOO.PARSER,e=i.conditional,n=this.trueInstance.bind(this),s=this.toResult.bind(this),t=console.assert,o=PQ_BAMBOO.Nodes;t(n(e,"5 is 5",o.Conditional)),t(n(e,"both true and true",o.Conditional)),t(n(e,"either true or false",o.Conditional)),t(n(e,"not true",o.Conditional)),t(s(e,"5 is 5",!0)),t(s(e,"both true and true",!0)),t(s(e,"both true and false",!1)),t(s(e,"either true or false",!0))},functions(){const s=PQ_BAMBOO.PARSER,n=s.statement;let t=this.true.bind(this);this.onlyParse&&(t=e=>e);let e=`machine A
 say 0
use A`;t(n,e),e=`machine A wants a
 a*a`,t(n,e),e+=`
give 5 to A`,t(n,e),e=`machine A wants a and b
 a*b
give 1 and 2 to A`,t(n,e),e=`machine A wants a
 a*a
give (1+2) to A`,t(n,e)},statements(){const i=PQ_BAMBOO.PARSER,e=console.assert,t=this.trueInstance.bind(this),o=i.oneKeywordStatements,s=i.multiKeywordStatements,a=i.statement,n=PQ_BAMBOO.Nodes;e(t(o,"stop",n.Keyword)),e(t(o,"output",n.Keyword)),e(t(o,"unplug",n.Keyword)),e(t(o,"skip",n.Keyword)),e(t(s,"> Comment",n.Comment)),e(t(s,"say ho",n.LogStatement)),e(t(s,"if 5 is 5",n.IfStatement)),e(t(s,"repeat 5 times",n.LoopStatement)),e(t(s,"machine A wants b",n.FunctionStatement)),e(t(s,"put 5 into VAR",n.Assignment));const r=`repeat 5 times 
 say "WHAT"`;e(t(a,r,n.Statement))}}}