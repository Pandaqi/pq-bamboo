(()=>{var A=class{constructor(e,t,n){this.bambooBlock=e,this.codeInput=t,this.codeDisplay=n,this.codeInput.addEventListener("keydown",this.handleCustomKeys.bind(this)),this.enabled=!0,this.selection,this.content,this.method="textarea",window.addEventListener("resize",this.updateDimensions.bind(this))}SelectionResult=class{constructor(e,t,n){this.anchorIndex=e,this.focusIndex=t,this.currentIndex=n}};updateDimensions(){if(this.method!="textarea")return;const e=this.codeDisplay.getBoundingClientRect().height+"px";this.codeDisplay.parentNode.style.height=e,this.codeInput.style.height=e}setEnabled(e){this.enabled=e}handleTab(e){const o=e.key=="Tab";if(!o)return;e.preventDefault(),e.stopPropagation();const t=this.codeInput,n=t.value;let i=n.slice(0,t.selectionStart),a=n.slice(t.selectionEnd,t.value.length),s=t.selectionEnd+1;t.value=i+"\xA0"+a,t.selectionStart=s,t.selectionEnd=s,t.focus(),this.bambooBlock.onInput()}handleEnter(){return!1}handleCustomKeys(e){if(!e)return!0;if(e.handled)return!0;this.handleTab(e),this.handleEnter(e)}getTextareaWithoutStyling(){let t=this.codeInput.value,e=t.split(`
`);for(let t=0;t<e.length;t++)e[t]="<span class='single-line-container'><span class='single-line'><span class='line-number'>"+(t+1)+"</span><span class='statement'>"+e[t]+"</span></span></span>";return e.join(`
`)}prepareStyling(){if(this.method=="textarea")return this.codeDisplay.innerHTML=this.getTextareaWithoutStyling(),this.codeInput.value;if(this.method=="editable"){const{selection:t,content:e}=this.getSelectionAndContent();return this.selection=t,this.content=e,e}}finishStyling(e){if(!this.enabled)return;this.method=="textarea"&&this.renderParsedText(e),this.method=="editable"&&e&&(this.renderParsedTextContentEditable(e),this.restoreSelection(this.selection))}getSelectionAndContent(){const t=window.getSelection(),o=this.getTextSegments();let n=null,s=null,e=0;o.forEach(({text:o,node:i})=>{i===t.anchorNode&&(n=e+t.anchorOffset),i===t.focusNode&&(s=e+t.focusOffset),e+=o.length}),n==null&&(n=e),s==null&&(s=e);const i=new this.SelectionResult(n,s,e),a=o.map(({text:e})=>e).join("");return{selection:i,content:a}}restoreSelection(e){const t=e.anchorIndex,n=e.focusIndex,c=window.getSelection(),l=this.getTextSegments();let s=this.node,o=this.node,i=0,a=0,r=0;l.forEach(({text:e,node:c})=>{const l=r,d=l+e.length;l<=t&&t<=d&&(s=c,i=t-l),l<=n&&n<=d&&(o=c,a=n-l),r+=e.length,lastText=e,lastNode=c}),c.setBaseAndExtent(s,i,o,a),this.node.focus()}getTextSegments(e=this.node){const t=[],n=Array.from(e.childNodes);return n.forEach(e=>{switch(e.nodeType){case Node.TEXT_NODE:t.push({text:e.nodeValue,node:e});break;case Node.ELEMENT_NODE:t.splice(t.length,0,...this.getTextSegments(e));break;default:throw new Error(`Unexpected node type: ${e.nodeType}`)}}),t}renderParsedText(e){if(this.updateDimensions(),!e||e=="")return;this.codeDisplay.innerHTML=e}renderParsedTextContentEditable(e){if(!e||e=="")return;this.node.innerHTML=e,this.node.innerHTML+="<br/><br/>"}},d={repeatString(e,t){let n="";for(let s=0;s<t;s++)n+=e;return n},divideString(e,t){for(let n=0;n<t.length;n++)e=e.replaceAll(t[n],"");return e}},t={toBool(e){this.numberToBool(e),this.stringToBool(e)},numberToBool(e){if(e.type!="number")return;e.set(parseInt(e.value)!=0,"bool")},stringToBool(e){if(typeof e.value!="string")return;e.set(e.value.length>0,"bool")},toNumber(e){this.boolToNumber(e),this.stringToNumber(e)},boolToNumber(e){if(e.type!="bool")return;let t=e.value;typeof t=="string"&&(t=t=="true"),e.set(t?1:0,"number")},stringToNumber(e){if(typeof e.value!="string")return;const t=parseFloat(e.value);isNaN(t)?e.set("Can't use string **"+e.value+"** as a number","error"):e.set(t,"number")},toString(e){this.boolToString(e),this.numberToString(e)},boolToString(e){if(e.type!="bool")return;e.set(e.value,"string")},numberToString(e){if(e.type!="number")return;e.set(e.value.toString(),"string")}},n={Identity:{toResult(e,t,n){return n.set(e.toResult(),e.type)}},Add:{toResult(e,n,s){return e.isBool()&&t.toNumber(e),n.isBool()&&t.toNumber(n),e.isNumber()&&n.isNumber()?s.set(e.toResult()+n.toResult(),"number"):s.set(e.toString()+n.toString(),"string")}},Sub:{toResult(e,n,s){if(e.isBool()&&t.toNumber(e),n.isBool()&&t.toNumber(n),e.isNumber()&&n.isNumber())return s.set(e.toResult()-n.toResult(),"number");if(e.isString()&&n.isNumber()){const t=e.toResult(),o=n.toResult();return s.set(t.slice(0,t.length-o),"string")}if(e.isNumber()&&n.isString())return s.set(n.toResult().slice(e.toResult()),"string");if(e.isString()&&n.isString()){let t=e.toResult();const o=n.toResult();return t.includes(o)&&(t=t.replace(o,"")),s.set(t,"string")}}},Mult:{toResult(e,n,s){if(e.isBool()&&t.toNumber(e),n.isBool()&&t.toNumber(n),e.isNumber()&&n.isNumber())return s.set(e.toResult()*n.toResult(),"number");if(e.isString()&&n.isNumber()){const t=d.repeatString(e.toResult(),n.toResult());return s.set(t,"string")}if(e.isNumber()&&n.isString()){const t=d.repeatString(n.toResult(),e.toResult());return s.set(t,"string")}e.isString()&&n.isString()}},Div:{toResult(e,n,s){if(e.isBool()&&t.toNumber(e),n.isBool()&&t.toNumber(n),e.isNumber()&&n.isNumber())return n.toResult()==0?s.set("Can't divide by zero!","error"):s.set(parseFloat(e.toResult())/parseFloat(n.toResult()),"number");if(e.isNumber()&&n.isString()){const t=n.toResult().length;return s.set(e.toResult()/t,"number")}if(e.isString()&&n.isNumber()){const t=e.toResult().length;return s.set(n.toResult()/t,"number")}if(e.isString()&&n.isString()){const t=d.divideString(e.toResult(),n.toResult());return s.set(t,"string")}}},Mod:{toResult(e,n,s){if(e.isBool()&&t.toNumber(e),n.isBool()&&t.toNumber(n),e.isNumber()&&n.isNumber())return s.set(e.toResult()%n.toResult(),"number");if(e.isString()&&n.isNumber()){const t=Math.round(e.toResult().length%n.toResult());return s.set(e.toResult().slice(0,t),"string")}if(e.isNumber()&&n.isString()){const t=n.toResult().length;return s.set(e.toResult()%t,"number")}if(e.isString()&&n.isString()){const t=e.toResult().replaceAll(n.toResult(),"");return s.set(t,"string")}}},Exp:{toResult(e,t,n){if(e.isNumber()&&t.isNumber()){const s=Math.pow(e.toResult(),t.toResult());return n.set(s,"number")}}},Equals:{toResult(e,n,s){const o=t;return e.isNumber()&&n.isString()&&o.toNumber(n),e.isString()&&n.isNumber()&&o.toString(n),e.isBool()&&o.toBool(n),n.isBool()&&o.toBool(e),s.set(e.toResult()==n.toResult(),"bool")}},LogicalAnd:{toResult(e,n,s){return t.toBool(e),t.toBool(n),s.set(e.toResult()&&n.toResult(),"bool")}},LogicalOr:{toResult(e,n,s){return t.toBool(e),t.toBool(n),s.set(e.toResult()||n.toResult(),"bool")}},LogicalNot:{toResult(e,n,s){return t.toBool(e),t.toBool(n),s.set(!e.toResult(),"bool")}},Above:{toResult(e,n,s){return t.toNumber(e),t.toNumber(n),s.set(e.toResult()>n.toResult(),"bool")}},Below:{toResult(e,n,s){return t.toNumber(e),t.toNumber(n),s.set(e.toResult()<n.toResult(),"bool")}},Round:{toResult(e,n){return t.toNumber(e),n.set(Math.round(e.toResult()),"number")}},Floor:{toResult(e,n){return t.toNumber(e),n.set(Math.floor(e.toResult()),"number")}},Ceiling:{toResult(e,n){return t.toNumber(e),n.set(Math.ceil(e.toResult()),"number")}},Absolute:{toResult(e,n){return t.toNumber(e),n.set(Math.abs(e.toResult()),"number")}},Number:{toResult(e,n){return t.toNumber(e),n.set(e.toResult(),"number")}},String:{toResult(e,n){return t.toString(e),n.set(e.toResult(),"string")}},UpperCase:{toResult(e,n){return t.toString(e),n.set(e.toResult().toUpperCase(),"string")}},LowerCase:{toResult(e,n){return t.toString(e),n.set(e.toResult().toLowerCase(),"string")}}},b=["iterator","value","random","time","draw","update"],f=["number","round","ceiling","floor","abs","string","uppercase","lowercase"],k=["plus","minus","times","divide","put","into","change","by","delete","now","means","if","is","and","or","not","above","below","true","false","both","either","stop","repeat","skip","search","machine","wants","give","to","use","unplug","output","say","comment","replace","with","select","in","from","add","to","take","out","of"],P=k.concat(b).concat(f),T={identity:n.Identity,"+":n.Add,plus:n.Add,"-":n.Sub,minus:n.Sub,"*":n.Mult,times:n.Mult,"/":n.Div,divide:n.Div,"%":n.Mod,mod:n.Mod,"^":n.Exp,exp:n.Exp,"=":n.Equals,is:n.Equals,"!":n.LogicalNot,not:n.LogicalNot,"&&":n.LogicalAnd,and:n.LogicalAnd,"||":n.LogicalOr,or:n.LogicalOr,above:n.Above,">":n.Above,below:n.Below,"<":n.Below,round:n.Round,floor:n.Floor,ceiling:n.Ceiling,abs:n.Absolute,number:n.Number,string:n.String,uppercase:n.UpperCase,lowercase:n.LowerCase},H={maxLoopCount:20,workerURL:"/tutorials/js/pq_bamboo/pqBamboo-webworker.min.js",builtinGlobals:b,tabCharacter:"\xA0",tabSize:2,builtinFunctions:f,keywords:P,operators:T},i=H,D=class{constructor(e){this.node=e.node,this.setupHTML(),this.parseResult=this.node.getElementsByClassName("parse-result")[0],this.feedback=this.parseResult.getElementsByClassName("parse-result-content")[0],this.debug=this.node.getElementsByClassName("bamboo-debug")[0],this.configForm=this.node.getElementsByClassName("bamboo-config-container")[0];const t=this;this.foldNode=this.node.getElementsByClassName("bamboo-fold")[0],this.isFolded()?(this.codeContainer.style.display="none",this.parseResult.style.display="none",this.foldNode.addEventListener("click",this.unfold.bind(this))):this.foldNode.style.display="none",this.configButton=this.node.getElementsByClassName("bamboo-config-btn")[0],this.configButton.addEventListener("click",e=>{const n=t.configForm.style.display=="block";return n?t.configForm.style.display="none":t.configForm.style.display="block",e.preventDefault(),e.stopPropagation(),!1}),this.highlighter=new A(this,this.codeInput,this.codeDisplay),this.codeInput.addEventListener("input",this.onInput.bind(this));const n=!this.isFolded();n&&this.onInput()}isFolded(){return this.node.dataset.folded=="true"}unfold(){this.node.dataset.folded="false",this.codeContainer.style.display="block",this.parseResult.style.display="block",this.foldNode.style.display="none",this.onInput()}onInput(){this.startExecuting()}startExecuting(){const e=this.highlighter.prepareStyling();this.feedback.innerHTML="Executing ...",this.thread&&this.thread.terminate(),this.thread=new Worker(i.workerURL),this.thread.addEventListener("message",this.finishExecuting.bind(this));let t={code:e,config:this.getConfig()};this.thread.postMessage(JSON.stringify(t))}finishExecuting(e){const t=JSON.parse(e.data),n=Object.keys(t).length<=0;if(n){this.highlighter.finishStyling("");return}this.highlighter.finishStyling(t.text),this.feedback.innerHTML=t.feedback,this.parseResult.style.display="block",t.feedback.length<=0&&(this.parseResult.style.display="none")}removeEmptyLinesAtStart(){const t=this.codeInput;let e=t.innerHTML;for(;!0;){const t=e.search(/\S/);if(t<=0)break;e=e.slice(1)}t.innerHTML=e}setupHTML(){this.codeContainer=this.node.getElementsByClassName("code-block")[0],this.codeInput=this.node.getElementsByClassName("code-block-input"),this.codeInput.length>0?this.codeInput=this.codeInput[0]:(this.codeInput=document.createElement("textarea"),this.codeInput.classList.add("code-block-input"),this.codeContainer.appendChild(this.codeInput)),this.codeDisplay=this.node.getElementsByClassName("code-block-display"),this.codeDisplay.length>0?this.codeDisplay=this.codeDisplay[0]:(this.codeDisplay=document.createElement("div"),this.codeDisplay.classList.add("code-block-display"),this.codeContainer.appendChild(this.codeDisplay)),this.codeDisplay.setAttribute("spellcheck",!1),this.codeInput.setAttribute("spellcheck",!1),this.setConfigInputs(),this.removeEmptyLinesAtStart()}setConfigInputs(){const e=this.node;let t=e.getElementsByClassName("bamboo-config-container")[0];const n=t.getElementsByTagName("input");for(const t of n)t.checked=e.dataset[t.name]=="true"}getConfig(){const n={disabled:[],fb:{log:!0,result:!0,value:!0,keyword:!0}},e={};Object.assign(e,n);const t=this.node,s=this.configForm.getElementsByTagName("input");for(const e of s)t.dataset[e.name]=e.checked;e.disabled=t.dataset.disabled.split(",");for(const n in e.fb)e.fb[n]=t.dataset["fb"+n]=="true";return e}},S=class{constructor(e,t){this.value=e.value.toString(),this.type=e.type,this.lineNumber=t}printPretty(e){return e=e.replace(/_(.*?)_/g,"<em>$1</em>"),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e}capitalize(e){return e.slice(0,1).toUpperCase()+e.slice(1)}print(e={}){let o=this.printPretty(this.value),t="<span class='line-num'>"+this.lineNumber+"</span>";this.lineNumber||(t="");let n=e.header||this.capitalize(this.type);n+=" > ";let s="bamboo-feedback-"+this.type;return e.class&&(s+=" "+e.class),"<div class='bamboo-feedback'><div class='"+s+"'>"+t+n+o+"</div></div>"}is(e){return this.type==e}isLiteral(){return this.type=="bool"||this.type=="number"||this.type=="string"}isBag(){return this.type=="bag"}},o=class{constructor(e,t){this.value=e,this.type=t}toString(){return"<span class='delimiter delimiter-"+this.type+"'>"+this.toOriginalString()+"</span>"}toOriginalString(){return this.value}},e=class{constructor(e=0,t="nothing",n=null,s=null){this.set(e,t),n&&(this.delimOpen=new o(n,"quote")),s&&(this.delimClose=new o(n,"quote"))}clone(){return new e(structuredClone(this.value),structuredClone(this.type))}setLabel(e){this.label=e}getLabel(){return this.label}print(e){return new S(this,e)}toResult(){const e=this.clone();return this.type=="number"?t.toNumber(e):this.type=="bool"?t.toBool(e):this.type=="string"&&t.toString(e),e.value}toString(){return"<span class='value "+this.type+"'>"+(this.delimOpen?this.delimOpen.toString():"")+this.value.toString()+(this.delimClose?this.delimClose.toString():"")+"</span>"}toLogString(){return this.value+""}toOriginalString(){return this.value}set(e,t){return this.setValue(e),this.setType(t),this}setType(e){this.type=e}getType(){return this.type}setValue(e){this.value=e}getValue(){return this.value}update(t){const s=i.operators["+"],n=new e;return s.toResult(this,t,n),this.set(n.value,n.type),this}isError(){return this.type=="error"}isBool(){return this.type=="bool"}isNumber(){return this.type=="number"}isString(){return this.type=="string"}isKeyword(e=""){const t=this.type=="keyword";return e?t&&this.value==e:t}getKeyword(){return!this.type=="keyword"?null:this.value}isTrue(){return!this.isError()&&this.toResult()}getSize(){return new e(this.toResult().length,"number")}getLabels(){}getItems(){}},c=class{constructor(e,t,n,s){this.keyword1=e,this.name=t,this.keyword2=n,this.params=s}toString(){return"<span class='function-statement'>"+this.keyword1.toString()+this.name.toString()+(this.keyword2?this.keyword2.toString():"")+(this.params?this.params.toString():"")+"</span>"}toResult(){return new e(this.getFunctionName(),"function")}getFunctionName(){return this.name.toOriginalString()}getParamsAsList(){return this.params?this.params.getParamsAsList():[]}},C=class{constructor(e=null,t={}){this.block=e,this.data=t}has(e){return e in this.data}get(e){return this.data[e]}set(e,t){return this.data[e]=t,t}delete(e){delete this.data[e]}getData(){return this.data}blocksScope(){return!!this.block&&!!this.block.header&&this.block.header.isDefinition(c)}},I=class{constructor(e){this.contexts=[],this.config=e}pushContext(e=void 0,t=void 0){const n=new C(e,t);return this.contexts.push(n),n.getData()}popContext(){return this.contexts.pop()}getLastContext(){return this.contexts[this.contexts.length-1]}scopeBlockingEnabled(){return!this.config.disabled.includes("scopeBlock")}error(t){return new e("Name **"+t+"** doesn't exist in memory!","error")}has(e){for(let t=this.contexts.length-1;t>=0;t--){const n=this.contexts[t];if(n.has(e))return!0;if(this.scopeBlockingEnabled()&&n.blocksScope())break}return!1}get(e){for(let t=this.contexts.length-1;t>=0;t--){const n=this.contexts[t];if(n.has(e))return n.get(e);if(this.scopeBlockingEnabled()&&n.blocksScope())break}return this.error(e)}set(e,t){for(let n=this.contexts.length-1;n>=0;n--){const s=this.contexts[n];if(s.has(e))return s.set(e,t);if(this.scopeBlockingEnabled()&&s.blocksScope())break}return this.getLastContext().set(e,t)}delete(e){for(let t=this.contexts.length-1;t>=0;t--){const n=this.contexts[t];if(n.has(e))return n.delete(e);if(n.blocksScope())break}return this.error(e)}},s=class{constructor(e){this.name=e,this.content={}}clone(){const e=new s(this.name);return e.setContent(this.content),e}print(t){return new e(this.toLogString(),"bag").print(t)}toLogString(){const e=[];for(const[t,n]of Object.entries(this.content))e.push(t+" => "+n);return"["+e.join(", ")+"]"}toResult(){return this}isKeyword(){return!1}getKeyword(){return null}isTrue(){return this.getSize()>0}getLabel(){return""}isError(){return!1}isBool(){return!1}isNumber(){return!1}isString(){return!1}setContent(e){this.content=e}addValue(e){let t=Object.keys(this.content).length,n=e;e.getLabel()&&(t=e.getLabel()),this.content[t]=n}removeValueByKey(t){const n=new e("Bag **"+this.name+"** doesn't have key **"+t+"**","error");if(this.isArray())return t=parseInt(t),isNaN(t)?n:this.content.splice(t,1);if(t=t+"",!(t in this.content))return n;const s=this.content[t];return delete this.content[t],s}push(e,t=null){return this.isArray()?(this.content.push(e),e):t?(this.content[t]=e,e):(this.addValue(e),e)}pop(){if(this.isEmpty())return new e;if(this.isArray())return this.content.pop();const t=Object.keys(this.content),n=t[t.length-1],s=this.content[n];return delete this.content[n],s}getValue(t){const n=new e("Bag **"+this.name+"** doesn't have key **"+t+"**","error");return this.isArray()?(t=parseInt(t),isNaN(t)?n:this.content[t]):(t=t+"",Object.keys(this.content).includes(t)?this.content[t]:n)}isEmpty(){return this.getSize()<=0}getSize(){let t=Object.keys(this.content).length;return this.isArray()&&(t=this.content.length),new e(t,"number")}getLabels(){const e=new s(this.name+"-labels");return e.setContent(this.getKeysRaw()),e}getItems(){const e=new s(this.name+"-items");return e.setContent(this.getValuesRaw()),e}isArray(){return Array.isArray(this.content)}isObject(){return typeof this.content=="object"}getKeysRaw(){const t=[];if(this.isArray())for(let e=0;e<this.content.length;e++)t.push(e);else for(const n of Object.keys(this.content))t.push(new e(n,"string"));return t}getValuesRaw(){return this.isArray()?this.content:Object.values(this.content)}getFirst(){if(this.getSize()<=0)return new e;const t=Object.keys(this.content),n=t[0],s=this.content[n].toResult().clone();return s}getLast(){if(this.getSize()<=0)return new e;const t=Object.keys(this.content),n=t[t.length-1],s=this.content[n].toResult().clone();return s}},l=class{constructor(e,t){this.space=new o(e,"space"),this.lineNumber=t}toString(){return"<span class='single-line-container'><span class='single-line'><span class='line-number'>"+this.lineNumber+"</span><span class='blank-line'>"+this.space.toString()+"</span></span></span>"}getLineNumber(){return this.lineNumber}},y=class{constructor(e,t,n){this.name=e,this.block=t,this.memory=n}call(e){const s=this.block.header.getDefinition(),t=s.getParamsAsList(!0),n=e.getParamsAsList(!1),o=Math.min(t.length,n.length);for(let e=0;e<o;e++){const s=t[e],i=n[e];this.memory[s]=i}return this.block.toResult(!0)}},_=class{constructor(e,t){this.keyword=e,this.conditional=t}toString(){return"<span class='if-statement'>"+this.keyword.toString()+this.conditional.toString()+"</span>"}toResult(){return this.conditional.toResult()}isTrue(){return this.toResult().isTrue()}},w=class{constructor(e,t,n){this.keyword1=e,t&&(this.value=t),n&&(this.keyword2=n)}toString(){return"<span class='loop-statement'>"+this.keyword1.toString()+(this.value?this.value.toString():"")+(this.keyword2?this.keyword2.toString():"")+"</span>"}toResult(){return new e(this.keyword1,"keyword")}getLoopCount(){return this.value?this.value.toResult().toResult():i.maxLoopCount}},p=class{constructor(e,t){this.keyword=e,this.bag=t}toString(){return"<span class='search-statement'>"+this.keyword.toString()+this.bag.toString()+"</span>"}isInvalid(){return!(this.bag.toResult()instanceof s)}toResult(){return new e(this.keyword,"keyword")}getLoopCount(){if(this.isInvalid())return 0;const e=this.bag.toResult().getSize();return e.toResult()}getLoopValues(){return this.isInvalid()?[]:this.bag.toResult().getValuesRaw()}},v=class{constructor(e,t,n){this.keyword1=e,this.name=t,this.keyword2=n}toString(){return"<span class='bag-statement'>"+this.keyword1.toString()+this.name.toString()+this.keyword2.toString()+"</span>"}toResult(){return new e("Creation of a new bag: "+this.toOriginalString(),"parser")}getBagName(){return this.name.toOriginalString()}},a=class{constructor(e){this.lexer=e,this.content=[],this.header=null,this.parent=null,this.feedback=[],this.memory={}}getLexer(){return this.lexer}addBlock(e){this.content.push(e)}addStatement(e){this.content.push(e)}getParentBlock(){return this.parent}setParentBlock(e){e.addBlock(this),this.parent=e}setHeader(e){this.header=e}toString(){let e=[];this.header&&e.push(this.header.toString());for(const t of this.content)e.push(t.toString());return"<span class='block'>"+e.join(`
`)+"</span>"}toResult(t=!1){this.feedback=[],this.parentMemory=this.lexer.memory.getLastContext();const n=this.toHeaderResult(t);if(n.result.type!="nothing"){const e=this.header.getLineNumber();this.feedback.push(n.result.print(e))}if(!n.execute)return this.bubbleUpFeedback(),n.result;n.newContext&&this.lexer.memory.pushContext(this,this.memory);const r=[];for(const e of this.content){const t=e instanceof l;if(t)continue;r.push(e)}let o=0,c=n.loopValues,d=new e,u=n.bag||new s;for(;!0;){let t=!n.loop;const l=new e(o,"number");this.lexer.setBambooMemory("iterator",l);let s=new e("No loop value (possibly not looping over a bag?)","error");o<c.length&&(s=c[o]),this.lexer.setBambooMemory("value",s);for(const s of r){const e=s.toResult(),i=s instanceof a;if(!i){const t=s.getLineNumber();this.feedback.push(e.print(t))}const c=e.getKeyword(),o=n.keywords.includes(c);if(o&&(e.isKeyword("output")||e.isKeyword("unplug"))){t=!0;break}if(d=e,u.addValue(e),o&&e.isKeyword("skip"))break;if(o&&e.isKeyword("stop")){t=!0;break}}if(o+=1,t=t||o>=n.loopCount||o>=i.maxLoopCount,t)break}return this.bubbleUpFeedback(),this.toHeaderCleanup(n),d}bubbleUpFeedback(){const e=!this.parent;if(e)return;this.parent.addFeedback(this.feedback)}addFeedback(e){this.feedback=this.feedback.concat(e)}getFeedback(){return this.feedback}toHeaderCleanup(e){e.newContext&&this.lexer.memory.popContext()}toHeaderResult(t=!1){const n={execute:!0,loop:!1,loopCount:1,loopValues:[],newContext:!1,bag:null,keywords:[],result:new e};if(!this.header)return n;const i=this.header.isDefinition(_),a=this.header.isDefinition(w),r=this.header.isDefinition(p),l=this.header.isDefinition(v),o=this.header.isDefinition(c);if(o&&(n.keywords=["unplug","output"]),n.newContext=!0,t)return n;if(i)return n.execute=this.header.getDefinition().isTrue(),n.execute||n.result.set("If statement false; skipped","parser"),n;if(a)return n.loopCount=this.header.getDefinition().getLoopCount(),n.loop=n.loopCount>0,n.keywords=["stop","skip"],n.result.set("Loop statement ("+n.loopCount+" times)","parser"),n;if(r)return n.loopCount=this.header.getDefinition().getLoopCount(),n.loop=n.loopCount>0,n.loopValues=this.header.getDefinition().getLoopValues(),n.keywords=["stop","skip"],n.result.set("Loop statement (through bag)","parser"),n;if(l){const e=this.header.getDefinition().getBagName(),t=new s(e,this.memory);return this.parentMemory.set(e,t),n.result.set("Bag defined","parser"),n.bag=t,n}if(o){const e=this.header.getDefinition().getFunctionName(),t=new y(e,this,this.memory);return this.parentMemory.set(e,t),n.execute=!1,n.result.set("Machine defined with name "+e,"parser"),n}return n}containsKeyword(e,t="stop"){return e.toResult()==t}},E=class{constructor(e,t,n,s){this.keyword1=e,this.value1=t,this.keyword2=n,this.value2=s}toString(){return"<span class='assignment'>"+this.keyword1.toString()+this.value1.toString()+(this.keyword2?this.keyword2.toString():"")+(this.value2?this.value2.toString():"")+"</span>"}toResult(){let e,t,n;if(this.keyword1.is("put"))e=this.value1.toResult(),t=this.value2.toOriginalString(),this.value2.getMemory().set(t,e),n=e;else if(this.keyword1.is("now"))t=this.value1.toOriginalString(),e=this.value2.toResult(),this.value1.getMemory().set(t,e),n=e;else if(this.keyword1.is("change")){t=this.value1.toOriginalString(),e=this.value2.toResult();let s=this.value1.getMemory().get(t);s.type!="error"&&s.update(e),n=s}else if(this.keyword1.is("delete")){t=this.value1.toOriginalString();let e=this.value1.getMemory();n=e.delete(t)}return n}},m=class{constructor(e){this.operatorSymbol=e}toString(){return this.operatorSymbol.toString()}getSymbolString(){return this.operatorSymbol.toOriginalString()}toResult(t,n){const p=this.getSymbolString(),g=!n||p=="identity",l=new e;let o=t.toResult().clone(),a=g?new e:n.toResult().clone();const O=this.operatorSymbol.getConfig();if(O.disabled.includes("typeCoercion")&&!g&&o.getType()!=a.getType())return l.set("Invalid comparison between data types","error"),l;const u=[];if(o.isError()&&u.push(o),a.isError()&&u.push(a),u.length>0)return l.set(u,"error"),l;const h=[];if(o.isKeyword()&&h.push(o),a.isKeyword()&&h.push(a),h.length>0)return l.set(h,"keyword"),l;let r=[o],c=[a],w=o instanceof s,j=a instanceof s,m=[];w&&(r=o.getValuesRaw(),m=o.getKeysRaw()),j&&(c=a.getValuesRaw(),m=a.getKeysRaw());const d=[],f=r.length==1||c.length==1,y=r.length==c.length&&!f,_=r.length!=c.length&&!f;if(f||_)for(let t=0;t<r.length;t++)for(let n=0;n<c.length;n++){let s=new e;i.operators[p].toResult(r[t],c[n],s),d.push(s)}if(y){const t=Math.max(r.length,c.length);for(let n=0;n<t;n++){let s=new e;i.operators[p].toResult(r[n],c[n],s),d.push(s)}}if(d.length==1)return d[0];const b={};for(let e=0;e<m.length;e++)b[m[e]]=d[e];const v=new s("unnamed");return v.setContent(b),v}},r=class{constructor(e,t,n,s){this.keyword1=e,this.value1=t,this.operator=new m(n),this.value2=s}toString(){return"<span class='conditional'>"+(this.keyword1?this.keyword1.toString():"")+(this.value1?this.value1.toString():"")+this.operator.toString()+this.value2.toString()+"</span>"}toResult(){return this.value1?this.operator.toResult(this.value1,this.value2):this.operator.toResult(this.value2)}},h=class{constructor(e,t="",n="identity",s=""){this.config=e,this.symbol=n,t&&(this.spaceBefore=new o(t,"space")),s&&(this.spaceAfter=new o(s,"space"))}toString(){return this.symbol=="identity"?"":"<span class='operator'>"+(this.spaceBefore?this.spaceBefore.toString():"")+"<span class='operator-symbol'>"+this.symbol+"</span>"+(this.spaceAfter?this.spaceAfter.toString():"")+"</span>"}toOriginalString(){return this.symbol}getConfig(){return this.config}},M=class{constructor(e,t,n){this.term=e,t||(t=new h),this.operator=new m(t),n&&(this.expression=n)}toString(){return"<span class='expression'>"+this.term.toString()+(this.operator&&this.expression?this.operator.toString()+this.expression.toString():"")+"</span>"}toResult(){return this.operator.toResult(this.term,this.expression)}},F=class{constructor(e="",t,n=""){this.value=t,e&&(this.delimOpen=new o(e,"open")),n&&(this.delimClose=new o(n,"close"))}toString(){return"<span class='factor'>"+(this.delimOpen?this.delimOpen.toString():"")+this.value.toString()+(this.delimClose?this.delimClose.toString():"")+"</span>"}toResult(){return this.value.toResult()}},O=class{constructor(e){this.spaceBefore=0,this.spaceAfter=0,this.value=e}toString(){let e=new Array(this.spaceBefore),t=new Array(this.spaceAfter);return e=e.fill(" ").join(""),t=t.fill(" ").join(""),this.spaceBefore==0&&(e=""),this.spaceAfter==0&&(t=""),"<span class='single-line-container'><span class='single-line'><span class='line-number'>"+this.lineNumber+"</span><span class='statement'>"+e+this.value.toString()+t+"</span></span></span>"}toResult(){return this.value.toResult()}setSpaceBefore(e){this.spaceBefore=e}setSpaceAfter(e){this.spaceAfter=e}getSpaceBefore(){return this.spaceBefore}getDefinition(){return this.value}isDefinition(e){return this.value instanceof e}setLineNumber(e){this.lineNumber=e}getLineNumber(){return this.lineNumber}},z=class{constructor(e,t,n){this.factor=e,t||(t=new h),this.operator=new m(t),n&&(this.term=n)}toString(){return"<span class='term'>"+this.factor.toString()+(this.operator&&this.term?this.operator.toString()+this.term.toString():"")+"</span>"}toResult(){return this.operator.toResult(this.factor,this.term)}},u=class{constructor(e,t){this.lexer=e,this.value=t}toString(){return"<span class='variable'>"+this.value.toString()+"</span>"}toResult(){return this.getMemory().get(this.value)}existsInMemory(){return this.getMemory().has(this.value)}isReservedKeyword(){return["size","labels","items"].includes(this.toOriginalString())}toKey(){return this.isReservedKeyword()?this.toOriginalString():this.existsInMemory()?this.toResult().toResult():this.toOriginalString()}getLabel(t){const n=this.toResult(),a=n instanceof s,o=t,i=t instanceof e;if(i&&(t=t.toOriginalString()),t=="size")return n.getSize();if(t=="labels")return n.getLabels();if(t=="items")return n.getItems();if(a)return n.getValue(t);const r=n.getType()=="string";if(r){let s=t;i&&o.getType()=="number"&&(s=o.toResult());const a=isNaN(s),r=!a;if(a){const t=n.toResult().indexOf(s);return new e(t,"number")}if(r){const t=n.toResult().at(s);return new e(t,"string")}}const c=Array.isArray(t)||typeof t=="object";return c?n[t]:new e("Can't access **"+t+"** on **"+this.toOriginalString()+"**","error")}toOriginalString(){return this.value}getMemory(){return this.lexer.memory}},N=class{constructor(e,t,n,s,o,i){this.lexer=e,this.keyword1=t,this.key=n,this.keyword2=s,this.keyword3=o,this.bagName=i}toString(){return"<span class='bag-push'>"+this.keyword1.toString()+(this.key?this.key.toString():"")+this.keyword2.toString()+this.keyword3.toString()+this.bagName.toString()+"</span>"}toResult(){const e=this.lexer.getMemory().get(this.bagName.toOriginalString());if(this.key){const n=this.key instanceof u;let t="";return n?t=this.key.toKey():t=this.key.toResult().toOriginalString(),e.removeValueByKey(t)}return e.pop()}},L=class{constructor(e,t,n,s,o){this.lexer=e,this.keyword1=t,this.value=n,this.keyword2=s,this.bagName=o}toString(){return"<span class='bag-push'>"+this.keyword1.toString()+this.value.toString()+this.keyword2.toString()+this.bagName.toString()+"</span>"}toResult(){const e=this.lexer.getMemory().get(this.bagName.toOriginalString()),t=this.value.toResult();return e.push(t)}},R=class{constructor(e,t="",n=""){this.value=e,t!=""&&(this.delimOpen=new o(t,"open")),n!=""&&(this.delimClose=new o(t,"close"))}toString(){let e="<span class='literal literal-"+this.value.getType()+"'>";return this.delimOpen&&(e+=this.delimOpen.toString()),e+=this.value.toString(),this.delimClose&&(e+=this.delimClose.toString()),e+="</span>",e}toResult(){return this.value}},g=class{constructor(e,t,n){this.space1=new o(e,"space"),this.value=t,this.space2=new o(n,"space")}toString(){return"<span class='keyword'>"+this.space1.toString()+this.value.toString()+this.space2.toString()+"</span>"}toResult(){return new e(this.value,"keyword")}toOriginalString(){return this.value}is(e){return this.value==e}},j=class{constructor(e,t){if(!e){this.list=[];return}this.list=[e],t&&(this.list=this.list.concat(t.flat()))}toString(){let e="<span class='function-parameters'>";for(const t of this.list)e+=t.toString();return e+="</span>",e}toResult(){}getParamsAsList(e=!0){const t=[];for(const n of this.list){if(n instanceof g)continue;e?t.push(n.toOriginalString()):t.push(n.toResult())}return t}},x=class{constructor(e,t,n,s,o){this.lexer=e,this.keyword1=t,this.keyword2=s,t&&s?(this.name=o,this.paramsList=n):s||(this.name=n,this.paramsList=null)}toString(){return"<span class='function-call'>"+this.keyword1.toString()+(this.paramsList?this.paramsList.toString():"")+(this.keyword2?this.keyword2.toString():"")+this.name.toString()+"</span>"}toResult(){const t=this.name.toOriginalString(),e=this.getMemory().get(t);return e instanceof y?e.call(this.getParamsList()):e}getParamsList(){return this.paramsList?this.paramsList:new j}getMemory(){return this.lexer.memory}},B=class{constructor(e){this.value=e}toString(){return"<span class='function-parameter'>"+this.value.toString()+"</span>"}toResult(){}toOriginalString(){return this.value.toString()}},V=class{constructor(e){this.value=e}toString(){return"<span class='bag-name'>"+this.toOriginalString()+"</span>"}toOriginalString(){return this.value}toResult(){}},$=class{constructor(e,t,n){this.lexer=e,this.keyword1=t,this.keyword2=n}toString(){return"<span class='bamboo-keyword'>"+this.keyword1.toString()+this.keyword2.toString()+"</span>"}toResult(){const t=this.keyword2.toString();if(t=="random")return new e(Math.random(),"number");if(t=="time"){const t=new s("time"),n=new Date,o={year:"getFullYear",month:"getMonth",day:"getDate",hours:"getHours",minutes:"getMinutes",seconds:"getSeconds",milliseconds:"getMilliseconds"};for(const[i,a]of Object.entries(o)){const s=new e(n[a](),"number");s.setLabel(i),t.addValue(s)}return t}const n=this.getBambooMemory(t);return n||new e("There's no **Bamboo** global with the name **"+t+"**","error")}getBambooMemory(e){return this.lexer.getBambooMemory(e)}},W=class{constructor(e,t){this.keyword=e,this.value=t}toString(){return"<span class='factor-keyword'>"+this.keyword.toString()+this.value.toString()+"</span>"}toResult(){const a=i.operators[this.keyword.toOriginalString()];let n=[this.value.toResult()];const r=n[0]instanceof s;r&&(n=this.value.toResult().getValuesRaw());const t=[];for(const o of n){const s=new e;a.toResult(o.clone(),s),t.push(s)}if(t.length==1)return t[0];const o=new s("unnamed");return o.setContent(t),o}},U=class{constructor(e){this.value=e}toString(){return"<span class='function-name'>"+this.toOriginalString()+"</span>"}toOriginalString(){return this.value.toString()}toResult(){}},K=class{constructor(e){this.value=e}toString(){return"<span class='label'>"+this.value.toString()+"</span>"}toKey(){let t=this.value;const n=t instanceof u;if(n){let e=t.toKey();if(e)return e}const s=t instanceof e;return s||(t=t.toResult()),t.toResult()}},q=class{constructor(e,t,n){this.name=e,this.keyword=t,this.value=n}toString(){return"<span class='literal-named'>"+this.name.toString()+this.keyword.toString()+this.value.toString()+"</span>"}toResult(){const e=this.value.toResult().clone();return e.setLabel(this.getLabel()),e}getLabel(){return this.name.toOriginalString()}},Y=class{constructor(e,t,n){this.variable=e,this.delimiter=t,this.label=n}toString(){return"<span class='variable-indexed'>"+this.variable.toString()+this.delimiter.toString()+this.label.toString()+"</span>"}toResult(){const e=this.label.toKey();return this.variable.getLabel(e)}},G=class{constructor(e,t){this.keyword=e,this.value=t}toString(){return"<span class='log-statement'>"+this.keyword.toString()+this.value.toString()+"</span>"}toResult(){const n=this.value.toResult(),t=new e(n.toLogString(),"log");return console.log(t),t}},X=class{constructor(e,t,n,s,o,i){this.keyword1=e,this.value1=t,this.keyword2=n,this.value2=s,this.keyword3=o,this.value3=i}toString(){return"<span class='replace-statement'>"+this.keyword1.toString()+this.value1.toString()+this.keyword2.toString()+this.value2.toString()+this.keyword3.toString()+this.value3.toString()+"</span>"}toResult(){const n=this.value3.toResult().clone(),s=this.value1.toResult().clone(),o=this.value2.toResult().clone();t.toString(n),t.toString(s),t.toString(o);const i=n.toResult().replaceAll(s.toResult(),o.toResult());return new e(i,"string")}},Q=class{constructor(e,t,n,s,o,i){this.keyword1=e,this.value1=t,this.keyword2=n,this.value2=s,this.keyword3=o,this.value3=i}toString(){return"<span class='slice-statement'>"+this.keyword1.toString()+this.value1.toString()+this.keyword2.toString()+this.value2.toString()+this.keyword3.toString()+this.value3.toString()+"</span>"}toResult(){const n=this.value3.toResult().clone(),s=this.value1.toResult(),o=this.value2.toResult().clone();t.toString(n),t.toNumber(s),t.toNumber(o);const i=n.toResult().slice(s.toResult(),o.toResult());return new e(i,"string")}},Z=class{constructor(t,n){this.delim=new o(t,"comment"),this.value=new e(n,"comment")}toString(){return"<span class='comment'>"+this.delim.toString()+"<span class='comment-content'>"+this.value+"</span></span>"}toResult(){return this.value}},J=class{setLexer(e){this.lexer=e}returnerDefault=e=>e;choice=(e,t=this.returnerDefault)=>{let n=e.slice();return s=>{if(!e.length)return[];let o=e[0];const a=o.length==0;a&&(o=o());const i=o(s),r=i.length;return r?[t(i[0]),i[1]]:this.choice(n.slice(1),t)(s)}};reducerDefault=e=>e.join("");seq=(e,t=this.reducerDefault)=>{let n=e.slice();return e=>{const o=(e,t)=>{const i=!e.length;if(i)return t;let n=e[0];const a=n.length==0;a&&(n=n());const r=t[1],s=n(r),c=s.length;if(!c)return[];const l=t[0],d=[...l,s[0]],u=[d,s[1]];return o(e.slice(1),u)},s=o(n,[[],e]),i=s.length>0;return i?[t(s[0]),s[1]]:[]}};someReduceDefault=e=>e.join("");some=(e,t=this.someReduceDefault)=>n=>{const s=(t,n)=>{const o=[t,n];if(!n)return o;const i=e(n),a=i.length;if(!a){const e=!o[0];return e?[]:o}const r=[...t,i[0]],c=i[1];return s(r,c)},[o,i]=s("",n),a=o;return a?[t(o),i]:[]};maybe=(e,t=void 0,n=void 0)=>this.choice([this.some(e,n),this.nothing],t);char=e=>t=>t.length?t[0]!=e?[]:[t[0],t.slice(1)]:[];charSpace=e=>e.length?/\s/.test(e[0])?[e[0],e.slice(1)]:[]:[];range=(e,t)=>n=>n[0]>=e&&n[0]<=t?[n[0],n.slice(1)]:[];nothing=e=>["",e];all=e=>[e,""];fail=e=>[];zero=this.char("0");onenine=this.range("1","9");digit=this.choice([this.zero,this.onenine]);digits=this.some(this.digit);sign=this.choice([this.char("+"),this.char("-"),this.nothing]);integer=this.choice([this.digits,this.digit,this.seq([this.sign,this.digits])]);fraction=this.choice([this.seq([this.char("."),this.digits]),this.nothing]);varChar=(e=!1)=>{const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",n=t+"0123456789";return s=>e?this.charChoice(t)(s):this.charChoice(n)(s)};varChars=this.seq([this.varChar(!0),this.maybe(this.varChar(!1))]);charChoice=e=>t=>t.length?e.includes(t[0])?[t[0],t.slice(1)]:[]:[];charChoiceList=e=>t=>{const n=[];for(const t of e)n.push(this.charChoice(t));return this.choice(n)(t)};chars=e=>t=>{if(t.length<e.length)return[];const n=t.slice(0,e.length)==e;return n?[t.slice(0,e.length),t.slice(e.length)]:[]};charNot=e=>t=>t.length&&t[0]===e?[]:[t[0],t.slice(1)];charsNot=e=>t=>t.length&&e.includes(t[0])?[]:[t[0],t.slice(1)];stringChar=this.charsNot(['"',`
`,`
`,``]);stringChars=this.maybe(this.stringChar);boolReturner=t=>new e(t=="true","bool");bool=this.choice([this.chars("true"),this.chars("false")],this.boolReturner);numberReduce=([t,n])=>new e(t+n,"number");number=this.seq([this.integer,this.fraction],this.numberReduce);stringReduce=([t,n,s])=>new e(n,"string",t,s);string=this.seq([this.char('"'),this.stringChars,this.char('"')],this.stringReduce);literalReturner=e=>new R(e);literal=this.choice([this.bool,this.number,this.string],this.literalReturner);optSpace=this.maybe(this.charSpace);reqSpace=e=>e.length<=0?this.nothing(e):this.some(this.charSpace)(e);charsExact=e=>t=>{if(t.length>e.length){const n=this.charSpace(t[e.length]).length;if(!n)return[]}return this.chars(e)(t)};operator=(e="+",t=!1)=>n=>{const s=([e,t,n])=>new h(this.lexer.config,e,t,n);let o=this.seq([this.optSpace,this.chars(e),this.optSpace],s);return t&&(o=this.seq([this.optSpace,this.chars(e),this.reqSpace],s)),o(n)};keywordReducer=([e,t,n])=>new g(e,t,n);keyword=e=>this.seq([this.optSpace,this.chars(e),this.reqSpace],this.keywordReducer);keywordChoiceList=i.keywords.map(e=>this.charsExact(e));iskeyword=this.choice(this.keywordChoiceList);namedValue=e=>t=>{const n=this.iskeyword(t),s=n.length;return s?this.fail(t):this.seq([this.varChars],e)(t)};bagNameReducer=([e])=>new V(e);bagName=this.namedValue(this.bagNameReducer);functionNameReducer=([e])=>new U(e);functionName=this.namedValue(this.functionNameReducer);functionParamReducer=([e])=>new B(e);functionParameter=this.namedValue(this.functionParamReducer);variableReducer=([e])=>new u(this.lexer,e);variable=this.namedValue(this.variableReducer);possessiveReducer=([e,t,n])=>new o(e+t+n,"possessive");possessive=this.seq([this.optSpace,this.chars("'s"),this.optSpace],this.possessiveReducer);labelReducer=([e])=>new K(e);label=this.seq([this.choice([this.literal,this.variable,()=>this.evaluation])],this.labelReducer);variableIndexedReducer=([e,t,n])=>new Y(e,t,n);variableIndexed=this.seq([this.variable,this.possessive,this.label],this.variableIndexedReducer);paramList=(e=!1)=>t=>{let n=this.functionParameter;e&&(n=()=>this.evaluation);const s=e=>e.flat(),o=([e,t])=>[e,t],i=this.maybe(this.seq([this.keyword("and"),n],o),void 0,s),a=([e,t])=>new j(e,t);return this.seq([n,i],a)(t)};functionCallReducer=([e,t,n,s])=>new x(this.lexer,e,t,n,s);functionCallWithParams=this.seq([this.keyword("give"),this.paramList(!0),this.keyword("to"),this.functionName],this.functionCallReducer);functionCallWithoutParams=this.seq([this.keyword("use"),this.functionName],this.functionCallReducer);functionCall=this.choice([this.functionCallWithoutParams,this.functionCallWithParams]);factorBracket=this.seq([this.char("("),this.optSpace,()=>this.evaluation,this.optSpace,this.char(")")],([e,t,n,s,o])=>new F(e+t,n,s+o));literalNamedReducer=([e,t,n])=>new q(e,t,n);literalNamed=this.seq([this.bagName,this.keyword("means"),()=>this.evaluation],this.literalNamedReducer);factor=this.choice([this.factorBracket,this.literalNamed,this.literal,this.functionCall,this.variableIndexed,this.variable]);termOperator=(e,t)=>this.seq([this.operator(e,t),()=>this.term],([e,t])=>({op:e,term:t}));termChoice=this.choice([this.termOperator("^",!1),this.termOperator("exp",!0),this.termOperator("*",!1),this.termOperator("times",!0),this.termOperator("/",!1),this.termOperator("divide",!0),this.termOperator("%",!1),this.termOperator("mod",!0),this.nothing]);termReducer=([e,t])=>t?new z(e,t.op,t.term):e;term=this.seq([this.factor,this.termChoice],this.termReducer);exprOperator=(e,t)=>this.seq([this.operator(e,t),()=>this.expression],([e,t])=>({op:e,expr:t}));exprChoice=this.choice([this.exprOperator("+",!1),this.exprOperator("plus",!0),this.exprOperator("-",!1),this.exprOperator("minus",!0),this.nothing]);expressionReducer=([e,t])=>t?new M(e,t.op,t.expr):e;expression=this.seq([this.term,this.exprChoice],this.expressionReducer);condOneOperator=(e,t)=>{const n=([e,t,n])=>new r(null,e,t,n);return this.seq([this.expression,this.operator(e,t),()=>this.conditional],n)};condTwoOperator=(e,t,n)=>{const s=([e,t,n,s])=>new r(e,t,n,s);return this.seq([this.keyword(e,n),this.expression,this.operator(t,n),()=>this.conditional],s)};unaryReducer=([e,t])=>new r(null,null,e,t);unaryNot=this.choice([this.seq([this.operator("!",!1),()=>this.conditional],this.unaryReducer),this.seq([this.operator("not",!0),()=>this.conditional],this.unaryReducer)]);condOneKeyword=this.choice([this.condOneOperator("=",!1),this.condOneOperator("is",!0),this.condOneOperator(">",!1),this.condOneOperator("above",!0),this.condOneOperator("<",!1),this.condOneOperator("below",!0)]);condTwoKeyword=this.choice([this.condTwoOperator("both","and",!0),this.condTwoOperator("either","or",!0)]);conditional=this.choice([this.unaryNot,this.condTwoKeyword,this.condOneKeyword,this.expression]);factorKeywordChoice=()=>{const e=[];for(const t of i.builtinFunctions)e.push(this.keyword(t));return this.choice(e)};factorKeyword=this.seq([this.factorKeywordChoice(),()=>this.conditional],([e,t])=>new W(e,t));bambooGlobalChoice=()=>{const e=[];for(const t of i.builtinGlobals)e.push(this.chars(t));return this.choice(e)};bambooKeyword=this.seq([this.keyword("bamboo"),this.bambooGlobalChoice()],([e,t])=>new $(this.lexer,e,t));replaceReducer=([e,t,n,s,o,i])=>new X(e,t,n,s,o,i);stringReplace=this.seq([this.keyword("replace"),()=>this.evaluation,this.keyword("with"),()=>this.evaluation,this.keyword("in"),()=>this.evaluation],this.replaceReducer);sliceReducer=([e,t,n,s,o,i])=>new Q(e,t,n,s,o,i);stringSlice=this.seq([this.keyword("select"),()=>this.evaluation,this.keyword("to"),()=>this.evaluation,this.keyword("from"),()=>this.evaluation],this.sliceReducer);bagPushReducer=([e,t,n,s])=>new L(this.lexer,e,t,n,s);bagPush=this.seq([this.keyword("add"),this.choice([()=>this.evaluation,this.literalNamed]),this.keyword("to"),this.bagName],this.bagPushReducer);bagPopReducer=([e,t,n,s,o])=>new N(this.lexer,e,t,n,s,o);bagPop=this.seq([this.keyword("take"),this.choice([()=>this.evaluation,this.nothing]),this.keyword("out"),this.keyword("of"),this.bagName],this.bagPopReducer);evaluation=this.choice([this.bambooKeyword,this.factorKeyword,this.bagPush,this.bagPop,this.stringReplace,this.stringSlice,this.conditional]);loopReducer=([e,t,n])=>new w(e,t,n);blockSomeReducer=e=>e[0];loopStatement=this.seq([this.keyword("repeat"),this.maybe(this.evaluation,void 0,this.blockSomeReducer),this.maybe(this.keyword("times"),void 0,this.blockSomeReducer)],this.loopReducer);searchReducer=([e,t])=>new p(e,t);searchStatement=this.seq([this.keyword("search"),this.evaluation],this.searchReducer);functionStatementReducer=([e,t,n,s])=>new c(e,t,n,s);functionStatement=this.seq([this.keyword("machine"),this.functionName,this.maybe(this.keyword("wants"),void 0,this.blockSomeReducer),this.maybe(this.paramList(!1),void 0,this.blockSomeReducer)],this.functionStatementReducer);commentReducer=([e,t])=>new Z(e,t);comment=this.seq([this.choice([this.char(">"),this.keyword("comment")]),this.stringChars],this.commentReducer);logReducer=([e,t])=>new G(e,t);logStatement=this.seq([this.keyword("say"),this.evaluation],this.logReducer);assignmentReducer=([e,t,n,s])=>new E(e,t,n,s);assignmentNow=this.seq([this.keyword("now"),this.variable,this.keyword("means"),this.evaluation],this.assignmentReducer);assignmentPut=this.seq([this.keyword("put"),this.evaluation,this.keyword("into"),this.variable],this.assignmentReducer);assignmentChange=this.seq([this.keyword("change"),this.variable,this.keyword("by"),this.evaluation],this.assignmentReducer);assignmentDelete=this.seq([this.keyword("delete"),this.variable],this.assignmentReducer);assignment=this.choice([this.assignmentNow,this.assignmentPut,this.assignmentChange,this.assignmentDelete]);ifReducer=([e,t,n])=>new _(e,t,n);ifStatement=this.seq([this.keyword("if"),this.evaluation],this.ifReducer);bagReducer=([e,t,n])=>new v(e,t,n);bagStatement=this.seq([this.keyword("bag"),this.bagName,this.keyword("holds")],this.bagReducer);oneKeywordStatements=this.choice([this.keyword("stop"),this.keyword("skip"),this.keyword("unplug"),this.keyword("output")]);multiKeywordStatements=this.choice([this.logStatement,this.ifStatement,this.loopStatement,this.searchStatement,this.functionStatement,this.bagStatement,this.assignment,this.comment,this.evaluation]);statement=this.choice([this.oneKeywordStatements,this.multiKeywordStatements],e=>new O(e))},ee=new J,te=ee,ne=class{constructor(e){this.config=e,this.memory=new I(e),this.memoryGlobal=this.memory.pushContext(),this.memoryGlobal.bamboo={}}getBambooMemory(e){return this.memoryGlobal.bamboo[e]}setBambooMemory(e,t){this.memoryGlobal.bamboo[e]=t}getMemory(){return this.memory}isInvalid(e){return!(e instanceof a)}isEmptyLine(e){const t=e.replace(/\s/g,"");return t.length<=0}parse(e){const t=this.parseCode(e);return this.isInvalid(t)?null:t}parseCode(e){const c=e.length-e.replaceAll("(","").length,d=e.length-e.replaceAll(")","").length;if(c!=d)return null;const u=e.split(/[\n]/),i=te;i.setLexer(this);const t=[];let r=!1,o=0;for(let e of u){if(o+=1,this.isEmptyLine(e)){t.push(new l(e,o));continue}e=e.replace("	","\xA0\xA0");const a=e.search(/\S/);e=e.slice(a);const c=e.length-e.trim().length;e=e.trim();const s=i.statement(e),d=!s.length||s[1]!="";if(d){r=!0;break}const n=s[0];t.push(n),n.setSpaceBefore(a),n.setSpaceAfter(c),n.setLineNumber(o)}if(r)return null;const n=[0];let s=new a(this);for(let e=0;e<t.length;e++){const i=n[n.length-1];let o=i;const r=e>=t.length-1;if(r)o=0;else{const n=t[e+1]instanceof l;n||(o=t[e+1].getSpaceBefore())}const c=o>i;if(c){n.push(o);const i=new a(this);i.setParentBlock(s),i.setHeader(t[e]),s=i;continue}s.addStatement(t[e]);const d=o<i;if(d){const e=n.indexOf(o);for(let t=n.length-1;t>e;t--)n.pop(),s=s.getParentBlock();continue}}return s}};self.PQ_BAMBOO||(self.PQ_BAMBOO={}),self.PQ_BAMBOO.Lexer=ne,self.addEventListener("load",()=>{const t=typeof WorkerGlobalScope!="undefined"&&self instanceof WorkerGlobalScope;if(t)return;const n=Array.from(document.getElementsByClassName("pq-bamboo")),e=[];for(const t of n){const s=new D({node:t});e.push(s)}self.PQ_BAMBOO.codeBlocks=e})})()